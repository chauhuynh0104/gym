<!-- 
////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////
//////////////Code ƒë∆∞·ª£c vi·∫øt b·ªüi Chauhuynh0104////////////////
/////////////http://fb.com/chauhuynh0104/////////////////////
//////////////////////079.567.9350//////////////////////////
////////////Vui l√≤ng t√¥n tr·ªçng b·∫£n quy·ªÅn t√°c gi·∫£///////////
//////////////////Kh√¥ng xo√° d√≤ng n√†y /////////////////////
/////////////////////////////////////////////////////////
////////////////////////////////////////////////////////
!-->
<!DOCTYPE html>

<html lang="vi">
<head>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Ki·ªÉm Tra Th·ªß Thu·∫≠t</title>
<link rel="stylesheet" href="https://chauhuynh0104.github.io/gym/giaodien.css">
<script>
    async function checkAccess() {
        const jsonUrl = 'https://raw.githubusercontent.com/chauhuynh0104/chauhuynh0104.txt/refs/heads/main/drchau.json';
        try {
            const res = await fetch(jsonUrl);
            if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i file JSON');
            const config = await res.json();

            if (!config.ACCESS_ALLOWED) {
                document.body.innerHTML = `<div style="padding:50px;text-align:center;color:red;font-size:20px">
                    <h2>B·∫¢O TR√å H·ªÜ TH·ªêNG</h2>
                    <p>${config.MESSAGE}</p>
                    ${config.REDIRECT_URL ? `<p>S·∫Ω chuy·ªÉn h∆∞·ªõng sau <span id='countdown'>5</span> gi√¢y...</p>` : ''}
                </div>`;
                if (config.REDIRECT_URL) {
                    let seconds = 5;
                    const timer = setInterval(() => {
                        seconds--;
                        document.getElementById('countdown').innerText = seconds;
                        if (seconds <= 0) {
                            clearInterval(timer);
                            window.location.href = config.REDIRECT_URL;
                        }
                    }, 1000);
                }
                return false;
            }
            return true;
        } catch (err) {
            document.body.innerHTML = `<div style='padding:50px;text-align:center;color:red'>
                <h2>KH√îNG T·∫¢I ƒê∆Ø·ª¢C C·∫§U H√åNH</h2><p>L·ªói truy c·∫≠p khi k·∫øt n·ªëi m·∫°ng.<br/> Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng truy·ªÅn internet.</p>
            </div>`;
            return false;
        }
    }

    async function loadAccountsFromTXT() {
        const txtUrl = 'https://raw.githubusercontent.com/chauhuynh0104/chauhuynh0104.txt/refs/heads/main/tkk.txt';
        const res = await fetch(txtUrl);
        const text = await res.text();
        const accounts = {};
        text.split('\n').forEach(line => {
            const [u, p] = line.trim().split(':');
            if (u && p) accounts[u] = p;
        });
        return accounts;
    }

    async function enableLogin(accounts) {
        const btn = document.getElementById('loginBtn');
        const userInput = document.getElementById('usernameInput');
        const passInput = document.getElementById('passwordInput');
        const errorDiv = document.getElementById('loginError');

        btn.addEventListener('click', () => {
            const user = userInput.value.trim();
            const pass = passInput.value.trim();
            if (accounts[user] && accounts[user] === pass) {
                sessionStorage.setItem('medUser', user);
                document.body.classList.remove('login-page');
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                errorDiv.style.display = 'none';
            } else {
                errorDiv.style.display = 'block';
            }
        });
    }
document.addEventListener('DOMContentLoaded', function() {
document.getElementById('showMoreSuggestionsCheckbox').addEventListener('change', function() {
    if (allProcedures.length > 0) {
        generateTimeSuggestions(allProcedures);
        filterByOperator();
    }
});
});

 window.addEventListener('DOMContentLoaded', async () => {
  const allow = await checkAccess();
  if (!allow) return;
  // Ch·ªâ ki·ªÉm tra ƒëƒÉng nh·∫≠p ƒë√£ l∆∞u; KH√îNG t·∫£i rule/procedures ·ªü ƒë√¢y
  checkSavedLogin();
});

</script>




</head>
<body>
<!-- THEME PICKER -->
<div id="themePicker" class="theme-picker" title="Ch·ªçn m√†u ch·ªß ƒë·ªÅ giao di·ªán">
 
 
  <button type="button" class="theme-swatch" data-theme="default" style="--swatch:#3498db" aria-label="M·∫∑c ƒë·ªãnh (Xanh d∆∞∆°ng)"></button>
  <button type="button" class="theme-swatch" data-theme="orange"  style="--swatch:#FF6600" aria-label="M√†u cam"></button>
  <button type="button" class="theme-swatch" data-theme="red"     style="--swatch:#FF0000" aria-label="M√†u ƒë·ªè"></button>
  <button type="button" class="theme-swatch" data-theme="green"   style="--swatch:#00AA00" aria-label="M√†u xanh l√°"></button>
   <button type="button" id="darkToggle" class="theme-dark-toggle" onclick="toggleDarkMode()" aria-label="B·∫≠t/T·∫Øt ch·∫ø ƒë·ªô t·ªëi">
    <span id="darkIcon"><small>üåô</small></span> <span id="darkText">T·ªëi</span>
  </button>
  
</div>




<script>
      function toggleDarkMode() {
        const body = document.body;
        const icon = document.getElementById("darkIcon");
        const text = document.getElementById("darkText");
        body.classList.toggle("dark-mode");
        const isDark = body.classList.contains("dark-mode");
        icon.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
        text.textContent = isDark ? "S√°ng" : "T·ªëi";
      }
    </script>
<script>
document.addEventListener('DOMContentLoaded', () => {
// L·∫•y c√°c ph·∫ßn t·ª≠
            const triggerButton = document.getElementById('triggerButton');
            const fileInput = document.getElementById('fileInput');

            // Ki·ªÉm tra xem ph·∫ßn t·ª≠ c√≥ t·ªìn t·∫°i kh√¥ng
            if (!triggerButton || !fileInput) {
                console.error('L·ªói: Kh√¥ng t√¨m th·∫•y triggerButton ho·∫∑c fileInput');
                return;
            }

            // Th√™m s·ª± ki·ªán click cho button
            triggerButton.addEventListener('click', () => {
                fileInput.click(); // K√≠ch ho·∫°t input file
            });

        });

</script>

<div class="container">
<div class="login-section" id="loginSection">
<h2 class="login-title">ƒêƒÇNG NH·∫¨P H·ªÜ TH·ªêNG</h2>
<input class="login-input" id="usernameInput" placeholder="T√™n ƒëƒÉng nh·∫≠p" type="text"/>
<input class="login-input" id="passwordInput" placeholder="M·∫≠t kh·∫©u" type="password"/>
<br/><button class="btn" id="loginBtn">ƒêƒÉng nh·∫≠p</button>
<div class="login-error" id="loginError">T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng</div>
</div>
<div class="main-content" id="mainContent">
<div class="top-button-group">
<button onclick="openCreateProcedure()" class="btn">T·∫°o Gi·ªù Th·ªß Thu·∫≠t</button>
  <button onclick="openCustomizePanel()" class="btn">Tu·ª≥ bi·∫øn</button>


<button onclick="showDropboxPanel()" class="btn">Panel</button>

  <button onclick="window.location.reload();" class="btn">Xo√° Cache</button>
  <button class="btn"id="logoutBtn">ƒêƒÉng xu·∫•t</button>
</div>


<h1> <a href="https://fb.com/chauhuynh0104" style="all: unset; cursor: pointer;" target="_blank">Ki·ªÉm Tra Th·ªß Thu·∫≠t</a></h1>
<div class="list1" style="display: flex; align-items: center; gap: 8px;">
<i class="fa fa-bullhorn"></i>
<b><font color="red">Th√¥ng b√°o:</font></b>
<div class="scrolling-text" style="flex: 1; overflow: hidden;">
<div class="scrolling-content" id="noidung">

</div>
</div>
</div>
<script>


fetch('https://raw.githubusercontent.com/chauhuynh0104/chauhuynh0104.txt/refs/heads/main/thongbao.txt')
  .then(response => response.text())
  .then(data => {
    const el = document.getElementById('noidung');
    el.innerHTML = data;

    // TƒÉng ƒë·ªô d√†i n·ªôi dung ƒë·ªÉ ƒë·∫£m b·∫£o cu·ªôn
    el.style.display = 'inline-block';
    el.style.minWidth = '100%';

    // Reset animation to force reflow
    el.style.animation = 'none';
    void el.offsetWidth;
    el.style.animation = 'scroll-left 10s linear infinite';
  })
  .catch(error => {
    document.getElementById('noidung').textContent = 'Kh√¥ng th·ªÉ t·∫£i n·ªôi dung.';
    console.error(error);
  });


</script>
<div class="upload-section"><div class="mainblok">

<input accept=".xlsx, .xls, .csv" id="fileInput" style="display:none" type="file"/>
<button class="btn" id="triggerButton"><i class="fas fa-file-upload"></i> Ch·ªçn file th·ªß c√¥ng</button>
<br/><br/>
<input directory="" id="folderInput" multiple="" style="display:none" type="file" webkitdirectory=""/>
<button class="btn" id="folderBtn"><i class="fas fa-folder-open"></i> Ch·ªçn th∆∞ m·ª•c (T·ª± ƒë·ªông t√¨m file)</button>
<div id="scanStatus" style="margin-top:10px;color:#3498db;font-weight:bold"></div>


<label>
<input name="timeOption" type="radio" value="7:00"/> 
                        G·ª£i √Ω t·ª´ 07:00
                    </label>
<label>
<input checked="" name="timeOption" type="radio" value="7:30"/> 
                        G·ª£i √Ω t·ª´ 07:30
                    </label>
<br/><br/>

  <label style="margin-right: 10px;">
<input checked="1" id="ignoreAdjacentCheckbox" type="checkbox"/>
<span class="chu-thich">B·ªè qua th·ªß thu·∫≠t li·ªÅn k·ªÅ<span class="noi-dung">VD: 8h00-8h30 xoa b√≥p. 08h30-08h50 ƒëi·ªán ch√¢m. li√™n ti·∫øp m√† ko c√°ch 1 ph√∫t </span></span>
</label>

  <label style="margin-right: 10px;">
<input id="showMoreSuggestionsCheckbox" type="checkbox"/> 
        Hi·ªÉn th·ªã 6 khung gi·ªù g·ª£i √Ω         
    </label>

<label>
<input id="showDoctorCheckbox" type="checkbox"/> 
        Hi·ªÉn th·ªã B√°c sƒ© ch·ªâ ƒë·ªãnh
    </label>
<br/><br/>
<button class="btn" id="analyzeBtn">Ki·ªÉm Tra</button>









<script>
document.getElementById('fileInput').addEventListener('change', function () {
    const file = this.files[0];
    if (file) {
        const status = document.getElementById('scanStatus');
        status.innerHTML = `<i class="fas fa-file"></i>ƒê√£ ch·ªçn file: <b>${file.name}</b>`;
        status.style.display = 'block';
        status.style.color = '#2c3e50';
    }
});

</script>
<div id="scanStatus" style="margin-top:10px; color:#2c3e50; font-weight:bold; display: none;"></div>
<br/>
<span style="font-size: 12px;"><i>Ph·∫ßn m·ªÅm ƒë√¥i khi c√≥ th·ªÉ m·∫Øc l·ªói. Xin h√£y ki·ªÉm tra c√°c th√¥ng tin quan tr·ªçng.</i></span>
<div id="fileRequirements"></div>
</div></div>


<!-- B·∫ÆT ƒê·∫¶U: B·∫¢NG GI·ªú TR·ªêNG T·ª™NG NG∆Ø·ªúI -->
  <button id="herbToggleBtn" class="btn" onclick="toggleHerbList()"style="display:none">S·∫Øc thu·ªëc thang</button>
  <button class="btn" onclick="toggleAvailability()" style="display:none">Gi·ªù tr·ªëng</button>
<button class="btn" id="errorSummaryBtn" onclick="openErrorSummary()" style="display:none">
  T√≥m T·∫Øt L·ªói
</button>
<div id="availabilityTable" style="display: none; margin-bottom: 20px;">
 <div class="mainblok" style="margin-bottom: 10px; display:none;" id="availabilityFilterBlock">
  <label for="filterOperator">Ng∆∞·ªùi th·ª±c hi·ªán:</label>
  <select id="filterOperator" class="login-input" style="width:auto;margin-right:20px;"></select>

  <label for="filterDate">Ng√†y:</label>
  <select id="filterDate" class="login-input" style="width:auto;"></select>
</div>

  <table class="error-table herb-table">
    <thead>
      <tr>
        <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
        <th>Ng√†y</th>
        
        <th>Khung gi·ªù tr·ªëng bu·ªïi s√°ng</th>
        <th>Khung gi·ªù tr·ªëng bu·ªïi chi·ªÅu</th>
      </tr>
    </thead>
    <tbody id="availabilityBody"></tbody>
  </table>
</div>
<!-- K·∫æT TH√öC: B·∫¢NG GI·ªú TR·ªêNG T·ª™NG NG∆Ø·ªúI -->




<!-- N√öT HI·ªÇN TH·ªä TH·ª¶ THU·∫¨T S·∫ÆC THU·ªêC -->


  
<!-- B·∫¢NG TH·ª¶ THU·∫¨T S·∫ÆC THU·ªêC THANG -->
<div id="herbProcedureTable" style="display: none; margin-top: 20px;">
  <div class="mainblok"style="margin-bottom: 10px;">
    <div>
    <select id="herbDoctorFilter" class="login-input" style="width:auto; margin-left: 20px;">
      <option value="all">T·∫•t c·∫£ b√°c sƒ©</option>
    </select>
    <select id="herbDateFilter" class="login-input" style="width:auto;"></select>
  </div></div>

<!-- T√ìM T·∫ÆT OUTLIER -->
<div id="herbOutlierSummary" style="display:none;margin:8px 20px;font-size:14px">
  <!-- n·ªôi dung s·∫Ω ƒë∆∞·ª£c JS c·∫≠p nh·∫≠t -->
</div>
  <table class="error-table">
    <thead>
      <tr>
        <th>H·ªç t√™n b·ªánh nh√¢n</th>
        <th>Th·ªß thu·∫≠t</th>
        <th>Ng√†y</th>
        <th>Th·ªùi gian</th>
        <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
      </tr>
    </thead>
    <tbody id="herbTableBody"></tbody>
  </table>
</div>


<!-- POPUP DANH S√ÅCH OUTLIER S·∫ÆC THU·ªêC THANG -->
<div id="herbOutlierModal" style="display:none;position:fixed;inset:0;z-index:11000">
  <div id="herbOutlierBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,0.5)"></div>
  <div role="dialog" aria-modal="true"
       style="position:absolute;top:10%;left:50%;transform:translateX(-50%);
              max-width:700px;max-height:80vh;overflow:auto;
              background:#fff;color:#000;padding:20px;border-radius:8px;
              border:2px solid #d32f2f;box-shadow:0 5px 20px rgba(0,0,0,0.3);font-family:Inter,sans-serif">
    <h3>Danh s√°ch ca kh√°c ƒëa s·ªë</h3>
    <div style="margin:10px 0;font-size:13px" id="herbOutlierModalInfo"></div>
    <table class="error-table" style="margin-top:10px">
      <thead>
        <tr>
          <th>H·ªç t√™n b·ªánh nh√¢n</th>
          <th>Th·ªß thu·∫≠t</th>
          <th>Ng√†y</th>
          <th>Th·ªùi gian</th>
          <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
        </tr>
      </thead>
      <tbody id="herbOutlierModalBody"></tbody>
    </table>
    <br/>
    <button class="btn" type="button" id="herbOutlierCloseBtn">ƒê√≥ng</button>
  </div>
</div>






<br/>
<br/><div id="errorSection" style="display: none;">
<br/>
<h3 id="errorSectionTitle">L·ªói Nh·∫≠p Sai Th·ªùi Gian</h3>
<div id="operatorFilterError" style="margin-top: 15px; display: none;">
<label for="operatorSelectError">L·ªçc theo ng∆∞·ªùi th·ª±c hi·ªán:</label>
<select class="login-input" id="operatorSelectError">
<option value="all">T·∫•t c·∫£</option>
</select>
</div>
<div id="errorLog"></div>
</div>
<br/>

<div id="resultSection" style="display: none;">
<h3 id="resultSectionTitle">Tr√πng Gi·ªù</h3> 

<div id="operatorFilter" style="margin-top: 15px; display: none;">
<label for="operatorSelect">L·ªçc theo ng∆∞·ªùi th·ª±c hi·ªán:</label>
<select class="login-input" id="operatorSelect">
<option value="all">T·∫•t c·∫£</option>
</select>
</div><br/>

<table id="resultTable">
<thead>
<tr>
<th><i class="fas fa-user fa-spin-continuous"></i> T√™n BN</th>
<th><i class="fas fa-procedures fa-spin-continuous"></i> Th·ªß thu·∫≠t</th>
<th><i class="far fa-calendar-alt fa-spin-continuous"></i> Ng√†y</th>
<th class="doctor-column"><i class="fas fa-user-md fa-spin-continuous"></i> B√°c s·ªπ ch·ªâ ƒë·ªãnh</th>
<th><i class="fas fa-user-nurse fa-spin-continuous"></i> Ng∆∞·ªùi th·ª±c hi·ªán</th>
<th><i class="far fa-clock fa-spin-continuous"></i> G·ª£i √Ω gi·ªù</th>
</tr>
</thead>
<tbody id="resultBody"></tbody>
</table>


</div>
</div>
</div>
<script>
// T·∫£i XLSX ch·ªâ khi c·∫ßn
async function ensureXLSX() {
  if (!window.XLSX) {
    await import('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
  }
}

// T·∫£i Dropbox SDK ch·ªâ khi c·∫ßn
async function ensureDropbox() {
  if (!window.Dropbox) {
    await import('https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js');
  }
}


        // Danh s√°ch th·ªß thu·∫≠t
       let PROCEDURES = {};

async function loadProcedures() {
    try {
        const res = await fetch('https://raw.githubusercontent.com/chauhuynh0104/chauhuynh0104.txt/refs/heads/main/chau_thuthuat.txt');
        const text = await res.text();
        PROCEDURES = JSON.parse(text);
    } catch (err) {
        alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch th·ªß thu·∫≠t: ' + err.message);
        console.error(err);
    }
}

		

        // Bi·∫øn to√†n c·ª•c
        let errorLog = [];
        let currentUser = null;
        let allProcedures = [];


const DROPBOX_CONFIG = {
    refreshToken: "ctgBvj3IstcAAAAAAAAAAVFCsIXIuz_CTQpImakcC4cuQV8DumkfgDWIs8VGPvFT",
    clientId: "w8awj2qxo3aiv5e",
    clientSecret: "qkqo1u7ats7bl9g"
};

async function getAccessToken() {
    const response = await fetch("https://api.dropboxapi.com/oauth2/token", {
        method: "POST",
        headers: {
            "Authorization": "Basic " + btoa(`${DROPBOX_CONFIG.clientId}:${DROPBOX_CONFIG.clientSecret}`),
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `grant_type=refresh_token&refresh_token=${DROPBOX_CONFIG.refreshToken}`
    });
    const data = await response.json();
    return data.access_token;
}
// T·∫£i XLSX ch·ªâ khi c·∫ßn
async function ensureXLSX() {
  if (!window.XLSX) {
    await import('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
  }
}

// T·∫£i Dropbox SDK ch·ªâ khi c·∫ßn
async function ensureDropbox() {
  if (!window.Dropbox) {
    await import('https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js');
  }
}
async function uploadToDropbox(file, khoaValue, ngayValue, stats = { herb: 0, time: 0, conflict: 0 }) {
  await ensureDropbox(); // ƒë·∫£m b·∫£o c√≥ Dropbox SDK
    const accessToken = await getAccessToken();
    const dbx = new Dropbox.Dropbox({ accessToken });

    const pcName = navigator.userAgent;
    const now = new Date().toLocaleString('vi-VN');
    const filename = `${file.name.replace(/\.[^/.]+$/, "")}_${Date.now()}.xlsx`;

    const response = await dbx.filesUpload({
        path: `/thuthuat/${filename}`,
        contents: file,
        mode: 'add',
        autorename: true
    });

    // Ghi metadata v√†o file JSON trung t√¢m (d·∫°ng text append)
    const metadata = {
        stt: Date.now(),
    khoa: khoaValue,        // ‚úÖ ƒë√∫ng bi·∫øn
    ngay: ngayValue,    // ‚úÖ ƒë√∫ng bi·∫øn
        link: "https://www.dropbox.com/home/thuthuat?preview=" + encodeURIComponent(filename),
        pc: pcName,
        time: now,
		herb_errors: Number(stats.herb) || 0,
    time_errors: Number(stats.time) || 0,
   conflict_errors: Number(stats.conflict) || 0
    };

    await appendDropboxLog(metadata);
}

async function appendDropboxLog(logItem) {
    const accessToken = await getAccessToken();
    const dbx = new Dropbox.Dropbox({ accessToken });

    const logPath = '/thuthuat/log.json';
    let logs = [];

    try {
        const response = await dbx.filesDownload({ path: logPath });
        const blob = response.result.fileBlob; // ‚úÖ d√πng .result.fileBlob
        const text = await blob.text();
        logs = JSON.parse(text);
    } catch (e) {
        console.warn("Kh√¥ng t√¨m th·∫•y log.json c≈© ho·∫∑c l·ªói ƒë·ªçc:", e);
        logs = [];
    }

    // Ch√®n m·ªõi nh·∫•t l√™n ƒë·∫ßu
    logs.unshift(logItem);

    await dbx.filesUpload({
        path: logPath,
        contents: JSON.stringify(logs, null, 2),
        mode: { '.tag': 'overwrite' }, // ‚úÖ Ghi ƒë√® b·∫Øt bu·ªôc
        autorename: false
    });
}


async function initAfterLogin() {
  await Promise.all([
    loadProcedures(),
    loadConflictRules()
  ]);
}



        // ========== PH·∫¶N ƒêƒÇNG NH·∫¨P ========== //
async function checkSavedLogin() {
    const savedUser = sessionStorage.getItem('medUser');
    if (savedUser) {
        currentUser = savedUser;
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        initAfterLogin(); // auto-login m·ªõi load d·ªØ li·ªáu
    }
}

let isLoginAction = false; // ‚úÖ Th√™m d√≤ng n√†y
let analyzePopupTimer; // ‚úÖ Th√™m d√≤ng n√†y
async function checkLogin() {
  const btnLogin   = document.getElementById('loginBtn');
  const username   = document.getElementById('usernameInput').value.trim();
  const password   = document.getElementById('passwordInput').value.trim();
  const loginError = document.getElementById('loginError');

  btnLogin.disabled = true;
  btnLogin.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ƒëƒÉng nh·∫≠p...';

  const popup       = document.getElementById('loadingPopup');
  const loadingText = document.getElementById('loadingText');
  const progressBar = document.getElementById('progressBar');

  let loginPopupShown = false;

  // Sau 2s ki·ªÉm tra: v·∫´n ·ªü trang ƒëƒÉng nh·∫≠p & ƒëang loading?
const slowLoginTimer = setTimeout(() => {
    if (!isLoginAction) return; // ‚úÖ Th√™m d√≤ng n√†y
    const loginSectionVisible = document.getElementById('loginSection').style.display !== 'none';
    const stillLoading = btnLogin.innerHTML.includes('ƒêang ƒëƒÉng nh·∫≠p');
    if (loginSectionVisible && stillLoading) {
      loadingText.innerHTML = `
        <i class="fas fa-satellite-dish fa-spin" style="font-size:24px;color:#e67e22;margin-bottom:10px;"></i><br/>
        <strong>ƒê∆∞·ªùng truy·ªÅn gi√°n ƒëo·∫°n</strong><br/><br/>
        Vui l√≤ng ƒë·ª£i v√†i gi√¢y ƒë·ªÉ kh·ªüi ƒë·ªông m√°y ch·ªß d·ª± ph√≤ng...
      `;
      progressBar.style.width = '0%';
      popup.style.display = 'flex';
      requestAnimationFrame(() => popup.classList.add('show'));
      loginPopupShown = true;
    let percent = 0;
progressBar.style.transition = 'width 0.2s linear';
const progressTimer = setInterval(() => {
    percent += 2; // tƒÉng m·ªói l·∫ßn 2%
    if (percent > 100) {
        percent = 100;
        clearInterval(progressTimer);
    }
    progressBar.style.width = percent + '%';
}, 500); // 100ms c·∫≠p nh·∫≠t 1 l·∫ßn

	
	}
  }, 2000);

  try {
    const accounts = await loadAccountsFromTXT();
    if (accounts[username] && accounts[username] === password) {
      currentUser = username;
      sessionStorage.setItem('medUser', username);
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      loginError.style.display = 'none';
      document.body.classList.remove('login-page');

      await initAfterLogin(); // ch·ªâ load sau khi login th√†nh c√¥ng
    } else {
      loginError.style.display = 'block';
    }
  } catch (err) {
    console.error('L·ªói khi ƒëƒÉng nh·∫≠p:', err);
    loginError.style.display = 'block';
  } finally {
    clearTimeout(slowLoginTimer);

    // N·∫øu popup do login m·ªü th√¨ ƒë√≥ng
    if (loginPopupShown && popup) {
      popup.classList.remove('show');
      setTimeout(() => { popup.style.display = 'none'; }, 400);
    }

    btnLogin.disabled = false;
    btnLogin.innerHTML = 'ƒêƒÉng nh·∫≠p';
  }
}


        function logout() {
            currentUser = null;
            sessionStorage.removeItem('medUser');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.body.classList.add('login-page');
        }

// ========== H√ÄM LOAD DANH S√ÅCH KHOA H·ª¢P L·ªÜ ========== //
async function loadValidDepartments() {
    const url = 'https://raw.githubusercontent.com/chauhuynh0104/chauhuynh0104.txt/refs/heads/main/khoa.txt';
    try {
        const res = await fetch(url);
        const text = await res.text();
        const khoaList = text.split('\n').map(line => line.trim().toLowerCase()).filter(Boolean);
        return khoaList;
    } catch (err) {
        console.error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch khoa:", err);
        return [];
    }
}

        // ========== PH·∫¶N X·ª¨ L√ù FILE ========== //
function handleFile() {
    const fileInput = document.getElementById('fileInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const file = fileInput.files[0];
	
if (!file) {
    const popup = document.getElementById('loadingPopup');
    const loadingText = document.getElementById('loadingText');
    const progressBar = document.getElementById('progressBar');

    loadingText.innerHTML = `
        <i class="fas fa-exclamation-triangle" style="font-size:24px;color:red;margin-bottom:10px;"></i><br/>
        <strong>Vui l√≤ng ch·ªçn file tr∆∞·ªõc khi ki·ªÉm tra</strong><br/><br/>
        <button class="btn" onclick="document.getElementById('loadingPopup').style.display='none'">ƒê√≥ng</button>
    `;
    progressBar.style.width = '0%';
    
    popup.style.display = 'flex';
    popup.classList.add('show');
    return;
}


    document.getElementById('fileRequirements').classList.add('hidden');
    errorLog = [];
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('errorSection').style.display = 'none';
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ki·ªÉm tra...';
    // ‚úÖ B·∫Øt ƒë·∫ßu ƒë·∫øm 2s ƒë·ªÉ hi·ªán popup n·∫øu v·∫´n ƒëang "ƒêang ki·ªÉm tra..."
clearTimeout(analyzePopupTimer);
analyzePopupTimer = setTimeout(() => {
    const btnAnalyze = document.getElementById('analyzeBtn');
    if (btnAnalyze.innerHTML.includes('ƒêang ki·ªÉm tra')) {
        const popup = document.getElementById('loadingPopup');
        const loadingText = document.getElementById('loadingText');
        const progressBar = document.getElementById('progressBar');

        loadingText.innerHTML = `
            <i class="fas fa-satellite-dish icon-spin" style="font-size:24px;color:#e67e22;margin-bottom:10px;"></i><br/>
            <strong>ƒê∆∞·ªùng truy·ªÅn gi√°n ƒëo·∫°n</strong><br/>
            Vui l√≤ng ƒë·ª£i v√†i gi√¢y ƒë·ªÉ kh·ªüi ƒë·ªông m√°y ch·ªß d·ª± ph√≤ng...
        `;
        progressBar.style.width = '0%';
        popup.style.display = 'flex';
        requestAnimationFrame(() => popup.classList.add('show'));

        // Ch·∫°y progressBar %
        let percent = 0;
        progressBar.style.transition = 'width 0.2s linear';
        const progressTimer = setInterval(() => {
            percent += 2;
            if (percent > 100) {
                percent = 100;
                clearInterval(progressTimer);
            }
            progressBar.style.width = percent + '%';
        }, 100);
    }
}, 5000);

    const reader = new FileReader();
    
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            if (workbook.SheetNames.length === 0) {
                throw new Error('File Excel kh√¥ng c√≥ sheet n√†o');
            }
            
            const firstSheet = workbook.Sheets[workbook.SheetNames[1]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                header: 1, 
                defval: "", 
                blankrows: true 
            });
            const dong5 = (jsonData[4] && jsonData[4][0]) ? jsonData[4][0].toString().trim() : "Kh√¥ng r√µ";
const dong6 = (jsonData[5] && jsonData[5][0]) ? jsonData[5][0].toString().trim() : "Kh√¥ng r√µ";
window.ngayValue = dong5;  // ‚¨Ö d√≤ng 5 = Ng√†y
window.khoaValue = dong6;  // ‚¨Ö d√≤ng 6 = Khoa


			//// Ki·ªÉm tra khoa /////
// ‚úÖ L·∫•y d·ªØ li·ªáu d√≤ng 6, c·ªôt A
const khoaRow = jsonData[5]; // d√≤ng 6
const khoaText = (khoaRow && khoaRow[0] || "").toString().trim();
const khoaLower = khoaText.toLowerCase();

// ‚úÖ Ki·ªÉm tra t√™n khoa
const validKhoaList = await loadValidDepartments();
if (!validKhoaList.some(khoa => khoaLower.includes(khoa))) {
      window.isKhoaLoi = true;
    const msg = `‚ùå M√°y ch·ªß t·ª´ ch·ªëi ${khoaText || 'Kh√¥ng x√°c ƒë·ªãnh'} s·ª≠ d·ª•ng ph·∫ßn m·ªÅm. <br/>Vui l√≤ng mua b·∫£n quy·ªÅn ƒë·ªÉ t√¥n tr·ªçng t√°c gi·∫£. `;

    // Hi·ªÉn popup ch·ª© kh√¥ng alert
 // Hi·ªÉn th·ªã popup
      const popup = document.getElementById('loadingPopup');
    const loadingText = document.getElementById('loadingText');
    const progressBar = document.getElementById('progressBar');

    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói vƒ©nh vi·ªÖn
    loadingText.innerHTML = `
        <i class="fas fa-ban" style="font-size:24px;color:red;font-size:20px;margin-bottom:10px;"></i><br/>
        <strong>${msg}</strong><br/><br/>
        <button class="btn" onclick="window.location.reload()">ƒê√≥ng</button>
    `;
    progressBar.style.width = '0%';

    popup.style.display = 'flex';
    popup.classList.add('show');

    // ‚úÖ V√î HI·ªÜU H√ìA b·∫•t k·ª≥ ƒëo·∫°n n√†o c·ªë g·∫Øng ·∫©n popup sau ƒë√≥
    window.isKhoaLoi = true;

    document.getElementById('scanStatus').innerHTML = `<span style="color:red;font-weight:bold">${msg}</span>`;
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('errorSection').style.display = 'none';
    return;
}



			
            if (jsonData.length <= 1) {
                throw new Error('File Excel kh√¥ng c√≥ d·ªØ li·ªáu (ch·ªâ c√≥ ti√™u ƒë·ªÅ ho·∫∑c tr·ªëng)');
            }
            
           processData(jsonData);
          const stats = {
            herb: getHerbOutlierTotal(),
              time: getTimeErrorTotal(),
             conflict: getConflictTotal()
          };
          const uploadFile = document.getElementById('fileInput').files[0];
 await uploadToDropbox(uploadFile, window.khoaValue, window.ngayValue, stats);
        } catch (error) {
            document.getElementById('fileRequirements').classList.remove('hidden');
            logError('L·ªói khi ƒë·ªçc file Excel', null, error.message);
            displayErrors();
            alert('C√≥ l·ªói x·∫£y ra khi ƒë·ªçc file: ' + error.message);
        } finally {
		clearTimeout(analyzePopupTimer); // ‚úÖ Ng·∫Øt timer popup
		document.getElementById('loadingPopup').classList.remove('show'); // ‚úÖ ·∫®n popup
    document.getElementById('loadingPopup').style.display = 'none';   // ‚úÖ ·∫®n h·∫≥n popup
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-search fa-spin-continuous"></i> Ki·ªÉm Tra';
        }
    };
    
    reader.onerror = function() {
        document.getElementById('fileRequirements').classList.remove('hidden');
        logError('L·ªói khi ƒë·ªçc file', null, 'Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung file');
        displayErrors();
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="fas fa-search fa-spin-continuous"></i> Ki·ªÉm Tra';
        alert('L·ªói khi ƒë·ªçc file. Vui l√≤ng th·ª≠ l·∫°i v·ªõi file kh√°c.');
    };
    
    reader.readAsArrayBuffer(file);
}

        function processData(data) {
    
    try {
        const headerLine1 = data[7] || [];
        const headerLine2 = data[8] || [];
        const combinedHeaders = headerLine1.map((col, index) => 
            (col + ' ' + (headerLine2[index] || '')).trim()
        );

        
                const procedureIndex = combinedHeaders.findIndex(h => h.includes("Th·ªß thu·∫≠t"));
				const dateIndex = combinedHeaders.findIndex(h => h.includes("Ng√†y th·ª±c hi·ªán")); // Th√™m d√≤ng n√†y
                const startIndex = combinedHeaders.findIndex(h => h.includes("Th·ªùi gian b·∫Øt ƒë·∫ßu th·ª±c hi·ªán"));
                const endIndex = combinedHeaders.findIndex(h => h.includes("Th·ªùi gian k·∫øt th√∫c"));
                const operatorIndex = combinedHeaders.findIndex(h => h.includes("Th·ªß thu·∫≠t ch√≠nh"));
                const nameIndex = combinedHeaders.findIndex(h => h.includes("H·ªç t√™n"));
                const patientIdIndex = combinedHeaders.findIndex(h => h.includes("M√£ BN"));
                const doctorIndex = combinedHeaders.findIndex(h => h.includes("B√°c s·ªπ ch·ªâ ƒë·ªãnh"));
                const missingColumns = [];
                if (procedureIndex === -1) missingColumns.push('Th·ªß thu·∫≠t');
                if (startIndex === -1) missingColumns.push('Th·ªùi gian b·∫Øt ƒë·∫ßu th·ª±c hi·ªán');
                if (endIndex === -1) missingColumns.push('Th·ªùi gian k·∫øt th√∫c');
                if (operatorIndex === -1) missingColumns.push('Th·ªß thu·∫≠t ch√≠nh');
                
                if (missingColumns.length > 0) {
                    throw new Error(`Kh√¥ng t√¨m th·∫•y c√°c c·ªôt b·∫Øt bu·ªôc: ${missingColumns.join(', ')}`);
                }
                
                const rows = data.slice(9);
                const procedures = [];
                const herbProcedures = [];
                let skippedRows = 0;
                
                rows.forEach((row, index) => {
                    const rowNumber = index + 10;
                    
                    try {
                        if (!row || row.length === 0) {
                            logError('D√≤ng tr·ªëng', rowNumber);
                            skippedRows++;
                            return;
                        }
                        
                        const procedureName = row[procedureIndex];
                        
                        if (!procedureName) {
                            skippedRows++;
                            return;
                        }
                        
                        if (!PROCEDURES[procedureName]) {
                            logError(`Th·ªß thu·∫≠t kh√¥ng n·∫±m trong danh s√°ch ki·ªÉm tra: ${procedureName}`, rowNumber);
                            skippedRows++;
                            return;
                        }
                        
                        if (PROCEDURES[procedureName].skip) {
                            const start = parseDateTime(row[startIndex], rowNumber);
                            const end = parseDateTime(row[endIndex], rowNumber);
                            herbProcedures.push({
                                rowIndex: rowNumber,
                                patientName: nameIndex !== -1 ? row[nameIndex] || 'Kh√¥ng c√≥' : 'Kh√¥ng c√≥',
                                patientId: patientIdIndex !== -1 ? row[patientIdIndex] || 'Kh√¥ng c√≥' : 'Kh√¥ng c√≥',
                                procedure: procedureName,
                                doctor: row[doctorIndex] || 'Kh√¥ng c√≥',
                                date: start?.dateKey || 'Kh√¥ng x√°c ƒë·ªãnh',
                                start: start?.seconds || 0,
                                end: end?.seconds || 0,
                                displayStart: start?.displayTime || '??',
                                displayEnd: end?.displayTime || '??',
                                operator: row[operatorIndex] || 'Kh√¥ng c√≥',
                                procedureInfo: PROCEDURES[procedureName]
                            });
                            return;
                        }
                        
                        const start = parseDateTime(row[startIndex], rowNumber);
                        const end = parseDateTime(row[endIndex], rowNumber);
                        
                        if (!start || !end) {
   
    skippedRows++;
    return;
}
                        
                        if (start.dateKey !== end.dateKey) {
                            logError('Th·ªß thu·∫≠t b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c kh√°c ng√†y', rowNumber, {
                                startDate: start.dateKey,
                                endDate: end.dateKey,
                                patientName: nameIndex !== -1 ? row[nameIndex] || 'Kh√¥ng c√≥' : 'Kh√¥ng c√≥',
                                procedure: procedureName
                            });
                            skippedRows++;
                            return;
                        }
                        
                        if (end.seconds <= start.seconds) {
    logError('Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu', rowNumber, {
        startTime: start.displayTime,
        endTime: end.displayTime,
        startValue: row[startIndex],
        endValue: row[endIndex],
        patientName: nameIndex !== -1 ? row[nameIndex] || 'Kh√¥ng c√≥' : 'Kh√¥ng c√≥',
        procedure: procedureName,
        ngayThucHien: dateIndex !== -1 ? row[dateIndex] : 'Kh√¥ng x√°c ƒë·ªãnh'
    });
    skippedRows++;
    return;
}
                        
                        const expectedDuration = PROCEDURES[procedureName]?.duration || 0;
                        const actualDurationMinutes = (end.seconds - start.seconds) / 60;
                        
if (expectedDuration > 0 && Math.abs(actualDurationMinutes - expectedDuration) > 1) {
    logError(``, rowNumber, {
        procedure: procedureName,
        expected: expectedDuration,
        actual: actualDurationMinutes,
        patientName: nameIndex !== -1 ? row[nameIndex] || 'Kh√¥ng c√≥' : 'Kh√¥ng c√≥',
        operator: row[operatorIndex] ? row[operatorIndex].replace(/,/g, '') : 'Kh√¥ng c√≥',
        date: start.dateKey,
        ngayThucHien: dateIndex !== -1 ? row[dateIndex] : 'Kh√¥ng x√°c ƒë·ªãnh',
        startTime: start.displayTime,
        endTime: end.displayTime,
        doctor: row[doctorIndex] || 'Kh√¥ng c√≥' // Th√™m d√≤ng n√†y
    });
}

                        
                        if (procedureName === 'S·∫Øc thu·ªëc thang') {
                            herbProcedures.push(procedures[procedures.length - 1]);
                        }
                        procedures.push({
                            rowIndex: rowNumber,
                            patientName: nameIndex !== -1 ? row[nameIndex] || 'Kh√¥ng c√≥' : 'Kh√¥ng c√≥',
                            patientId: patientIdIndex !== -1 ? row[patientIdIndex] || 'Kh√¥ng c√≥' : 'Kh√¥ng c√≥',
                            procedure: procedureName,
							doctor: row[doctorIndex] || 'Kh√¥ng c√≥',
                            date: start.dateKey,
                            start: start.seconds,
                            end: end.seconds,
                            displayStart: start.displayTime,
                            displayEnd: end.displayTime,
                            operator: row[operatorIndex] || 'Kh√¥ng c√≥',
                            conflict: false,
                            conflictReason: '',
                            procedureInfo: PROCEDURES[procedureName],
                            suggestion: ''
                        });
                    } catch (error) {
                        logError(`L·ªói x·ª≠ l√Ω d√≤ng: ${error.message}`, rowNumber, {
                            patientName: nameIndex !== -1 ? row[nameIndex] || 'Kh√¥ng c√≥' : 'Kh√¥ng c√≥',
                            procedure: row[procedureIndex] || 'Kh√¥ng c√≥',
                            errorDetails: error.stack
                        });
                        skippedRows++;
                    }
                });
                
                if (procedures.length === 0) {
                    throw new Error('Kh√¥ng c√≥ th·ªß thu·∫≠t n√†o h·ª£p l·ªá ƒë·ªÉ ki·ªÉm tra. Vui l√≤ng ki·ªÉm tra l·∫°i d·ªØ li·ªáu.');
                }
                
                checkConflicts(procedures);
                generateTimeSuggestions(procedures);
                displayResults(procedures, skippedRows);
                window.allHerbProcedures = herbProcedures;
				// --- C·∫≠p nh·∫≠t s·ªë ca kh√°c ƒëa s·ªë tr√™n n√∫t ---
setTimeout(() => {
  if (typeof updateHerbButtonWithOutlierCount === 'function') {
    updateHerbButtonWithOutlierCount();
  }
}, 100);

                displayErrors();
            } catch (error) {
                logError(error.message, null, error.stack);
                displayErrors();
                alert('C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω d·ªØ li·ªáu: ' + error.message);
            }
        }


let conflictRulesText = '';

async function loadConflictRules() {
    try {
        const url = 'https://raw.githubusercontent.com/chauhuynh0104/chauhuynh0104.txt/refs/heads/main/chau_xlthuthuat.txt?ts=' + Date.now();
        const res = await fetch(url);
        if (!res.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c chau_xlthuthuat.txt');
        conflictRulesText = (await res.text()).trim();
    } catch (e) {
        console.error('L·ªói t·∫£i chau_xlthuthuat.txt:', e);
        conflictRulesText = ''; // fallback: r·ªóng -> coi nh∆∞ kh√¥ng c√≥ ngo·∫°i l·ªá
    }
}




        function checkConflicts(procedures) {
            const ignoreAdjacent = document.getElementById('ignoreAdjacentCheckbox').checked;
            const groups = {};
            
            procedures.forEach(proc => {
                const key = `${proc.operator}_${proc.date}`;
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(proc);
            });
            
            Object.values(groups).forEach(group => {
                group.sort((a, b) => a.start - b.start);
                
                for (let i = 1; i < group.length; i++) {
                    const prev = group[i - 1];
                    const current = group[i];
                    const prevEndWithBuffer = prev.end + (prev.procedureInfo?.buffer || 0) * 60;
                    
                    const isAdjacent = ignoreAdjacent && current.start === prev.end;
                    
                    if (current.start < prevEndWithBuffer && !isAdjacent) {
                 

let isConflict = true;
    try {
        if (conflictRulesText && conflictRulesText.trim()) {
            const conflictCondition = new Function('prev','current','return ' + conflictRulesText.trim());
            // conflictCondition() TR·∫¢ V·ªÄ true n·∫øu *ƒë∆∞·ª£c mi·ªÖn xung ƒë·ªôt*
            const allowed = conflictCondition(prev, current);
            isConflict = !allowed;
        } else {
            isConflict = true; // kh√¥ng c√≥ rule -> c·ª© b√°o xung ƒë·ªôt
        }
    } catch (err) {
        console.error('L·ªói khi ƒë√°nh gi√° xung ƒë·ªôt th·ªùi gian:', err);
        isConflict = true;
    }
                        
                        if (isConflict) {
                            current.conflict = true;
                            current.conflictReason = `${prev.procedure}<br>‚Ä¢ B·ªánh nh√¢n: ${prev.patientName}<br>‚Ä¢ Ng√†y: ${prev.date}<br>‚Ä¢ Th·ªùi gian: ${prev.displayStart}-${prev.displayEnd}`;

                            prev.conflict = true;
                            if (!prev.conflictReason.includes(current.procedure)) {
                                prev.conflictReason += (prev.conflictReason ? '<br><br>' : '') + 
                                    ` ${current.procedure}<br>‚Ä¢ B·ªánh nh√¢n: ${current.patientName}<br>‚Ä¢ Ng√†y: ${current.date}<br>‚Ä¢ Th·ªùi gian: ${current.displayStart}-${current.displayEnd}`;
                            }
                        }
                    }
                }
            });
        }

function generateTimeSuggestions(procedures) {
    const timeOption = document.querySelector('input[name="timeOption"]:checked').value;
    const startHour = timeOption === '7:30' ? 7.5 : 7;
    const ignoreAdjacent = document.getElementById('ignoreAdjacentCheckbox').checked;
    const bufferMinutes = ignoreAdjacent ? 0 : 1;
    const showMoreSuggestions = document.getElementById('showMoreSuggestionsCheckbox').checked;
    
    // S·ªë khung gi·ªù t·ªëi ƒëa m·ªói bu·ªïi (n·∫øu ch·ªçn 6 khung th√¨ 3 s√°ng + 3 chi·ªÅu)
    const maxMorning = showMoreSuggestions ? 3 : 2;
    const maxAfternoon = showMoreSuggestions ? 3 : 1;

    procedures.forEach(proc => {
        if (!proc.conflict) return;

        const sameDayProcedures = procedures.filter(p => 
            p.date === proc.date && 
            p.operator === proc.operator &&
            p.rowIndex !== proc.rowIndex
        );

        const durationSeconds = proc.end - proc.start + (bufferMinutes * 60);
        
        // T√¨m khung gi·ªù bu·ªïi s√°ng
        const morningSlots = findAvailableSlots(
            startHour * 3600, 
            11.5 * 3600, 
            durationSeconds, 
            sameDayProcedures, 
            maxMorning
        );
        
        // T√¨m khung gi·ªù bu·ªïi chi·ªÅu
        const afternoonSlots = findAvailableSlots(
            13.5 * 3600, 
            17 * 3600, 
            durationSeconds, 
            sameDayProcedures, 
            maxAfternoon
        );

        // Format k·∫øt qu·∫£
        let suggestions = [];
        if (morningSlots.length > 0) {
            suggestions.push('<strong>S√°ng:</strong><br>' + 
                morningSlots.map(slot => `${slot.start} - ${slot.end}`).join('<br>'));
        }
        if (afternoonSlots.length > 0) {
            suggestions.push('<strong>Chi·ªÅu:</strong><br>' + 
                afternoonSlots.map(slot => `${slot.start} - ${slot.end}`).join('<br>'));
        }

        
if (morningSlots.length + afternoonSlots.length > 0) {
    const firstSlot = morningSlots[0] || afternoonSlots[0];
    const smartHint = `<br><div style="margin-top:6px;color:#00796b;font-weight:600">
    üëâ G·ª£i √Ω: D·ªùi t·ª´ <u>${proc.displayStart}</u> ‚Üí <u>${firstSlot.start}</u>
    </div>`;

    proc.suggestion = suggestions.join('<br>') + smartHint;
} else {
    proc.suggestion = '<span class="no-suggestion">Kh√¥ng c√≥ khung gi·ªù tr·ªëng</span>';
}

    });
}
// H√†m ki·ªÉm tra xung ƒë·ªôt th·ªùi gian
function hasTimeConflict(startTime, duration, procedures) {
    const endTime = startTime + duration;
    
    for (const proc of procedures) {
        const procStart = proc.start;
        const procEnd = proc.end + (proc.procedureInfo?.buffer || 0) * 60;
        
        if ((startTime >= procStart && startTime < procEnd) || 
            (endTime > procStart && endTime <= procEnd) ||
            (startTime <= procStart && endTime >= procEnd)) {
            return true;
        }
    }
    
    return false;
}
// H√†m t√¨m khung gi·ªù tr·ªëng
function findAvailableSlots(startTime, endTime, duration, procedures, maxSlots) {
    const slots = [];
    let currentTime = startTime;
    const ignoreAdjacent = document.getElementById('ignoreAdjacentCheckbox').checked;
    const bufferMinutes = ignoreAdjacent ? 0 : 1;
    
    while (currentTime + duration <= endTime && slots.length < maxSlots) {
        if (!hasTimeConflict(currentTime, duration, procedures)) {
            slots.push({
                start: secondsToTimeStr(currentTime),
                end: secondsToTimeStr(currentTime + (duration - (bufferMinutes * 60))) // Tr·ª´ buffer ƒë·ªÉ hi·ªÉn th·ªã
            });
        }
        currentTime += 15 * 60; // Ki·ªÉm tra m·ªói 15 ph√∫t
    }
    
    return slots;
}

        function secondsToTimeStr(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }


// ƒê·∫øm t·ªïng ca "s·∫Øc thu·ªëc" kh√°c ƒëa s·ªë (outlier)
function getHerbOutlierTotal() {
  const herbs = Array.isArray(window.allHerbProcedures) ? window.allHerbProcedures : [];
  const countsByDate = {};
  herbs.forEach(h => {
    const d = h.date;
    const n = (h.operator || 'Kh√¥ng c√≥').trim().toLowerCase();
    if (!countsByDate[d]) countsByDate[d] = {};
    countsByDate[d][n] = (countsByDate[d][n] || 0) + 1;
  });
  let outliers = 0;
  Object.values(countsByDate).forEach(map => {
    const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
    const top = entries[0]; if (!top) return;
    const topName = top[0];
    entries.forEach(([name, cnt]) => { if (name !== topName) outliers += cnt; });
  });
  return outliers;
}

// ƒê·∫øm l·ªói sai th·ªùi gian (k·∫øt th√∫c <= b·∫Øt ƒë·∫ßu, ƒë·ªãnh d·∫°ng sai, sai ph√∫t so v·ªõi quy ƒë·ªãnh,...)
function getTimeErrorTotal() {
  // ƒê·∫øm ƒë√∫ng theo s·ªë h√†ng l·ªói ƒëang hi·ªÉn th·ªã
  const container = document.getElementById('errorLog'); // v√πng b·∫£ng l·ªói th·ªùi gian
  if (!container) return 0;
  return container.querySelectorAll('tr.error-row').length;
}

function getConflictTotal() {
  // ƒê·∫øm ƒë√∫ng theo s·ªë h√†ng xung ƒë·ªôt trong k·∫øt qu·∫£
  const tbody = document.getElementById('resultBody'); // tbody c·ªßa b·∫£ng k·∫øt qu·∫£
  if (!tbody) return 0;
  return tbody.querySelectorAll('tr.conflict-row').length;
}








       function displayResults(procedures, skippedRows = 0) {
    allProcedures = procedures;
    
    const operators = [...new Set(procedures.map(p => p.operator))];
    const operatorSelect = document.getElementById('operatorSelect');
    const operatorSelectError = document.getElementById('operatorSelectError');
    
    operatorSelect.innerHTML = '<option value="all">T·∫•t c·∫£</option>' + 
        operators.map(op => `<option value="${op}">${op.replace(/,/g, '')}</option>`).join('');
    
    operatorSelectError.innerHTML = operatorSelect.innerHTML; // ƒê·ªìng b·ªô n·ªôi dung
    
    document.getElementById('operatorFilter').style.display = 'block';
    document.getElementById('operatorFilterError').style.display = 'block';
            
            const conflictProcedures = procedures.filter(p => p.conflict);
            const conflictCount = conflictProcedures.length;
            
            
            
            filterByOperator();
             document.getElementById('resultSection').style.display = 'block';
    
    // N·∫øu kh√¥ng c√≥ l·ªói, cu·ªôn xu·ªëng ph·∫ßn k·∫øt qu·∫£
    if (errorLog.length === 0) {
        setTimeout(() => {
            const resultSection = document.getElementById('resultSection');
            if (resultSection) {
                smoothScrollTo(resultSection, -40);
            }
        }, 300);
    }
}

function filterByOperator() {
    const operator = document.getElementById('operatorSelect').value;

 const showDoctor = document.getElementById('showDoctorCheckbox').checked;
    document.body.classList.toggle('show-doctor', showDoctor);
    // ===== 1. L·ªåC V√Ä HI·ªÇN TH·ªä B·∫¢NG K·∫æT QU·∫¢ KI·ªÇM TRA XUNG ƒê·ªòT =====
    const filteredProcedures = operator === 'all' 
        ? allProcedures.filter(p => p.conflict) 
        : allProcedures.filter(p => p.operator.replace(/,/g, '') === operator.replace(/,/g, '') && p.conflict);

    const resultBody = document.getElementById('resultBody');
    resultBody.innerHTML = '';

    // Nh√≥m c√°c th·ªß thu·∫≠t xung ƒë·ªôt v·ªõi nhau
    const conflictGroups = [];
    const processedRows = new Set();

    filteredProcedures.forEach(proc => {
        if (!processedRows.has(proc.rowIndex)) {
            const group = [proc];
            processedRows.add(proc.rowIndex);

            // T√¨m th·ªß thu·∫≠t li√™n quan trong xung ƒë·ªôt
            if (proc.conflictReason) {
                const conflictMatches = proc.conflictReason.match(/B·ªánh nh√¢n: (.*?)<br>‚Ä¢ Ng√†y: (.*?)<br>‚Ä¢ Th·ªùi gian: (.*?)-/g);
                if (conflictMatches) {
                    conflictMatches.forEach(match => {
                        const patientName = match.match(/B·ªánh nh√¢n: (.*?)<br>/)[1];
                        const date = match.match(/Ng√†y: (.*?)<br>/)[1];
                        const time = match.match(/Th·ªùi gian: (.*?)-/)[1];

                        const conflictProc = filteredProcedures.find(p => 
                            p.patientName === patientName && 
                            p.date === date && 
                            p.displayStart === time &&
                            !processedRows.has(p.rowIndex)
                        );

                        if (conflictProc) {
                            group.push(conflictProc);
                            processedRows.add(conflictProc.rowIndex);
                        }
                    });
                }
            }
            conflictGroups.push(group);
        }
    });

   // Hi·ªÉn th·ªã k·∫øt qu·∫£
    conflictGroups.forEach(group => {
        group.forEach(proc => {
            const row = document.createElement('tr');
            row.classList.add("herb-row");
            row.classList.add('conflict-row');
            row.innerHTML = `
                <td>${proc.patientName} <br/> ${proc.patientId}</td>
                <td>${proc.procedure}</td>
                <td><center>${proc.date}<br/>${proc.displayStart} - ${proc.displayEnd}</center></td>
                <td class="doctor-column">${proc.doctor}</td>
                <td>${proc.operator.replace(/,/g, '')}</td>
                <td class="time-suggestion">${proc.suggestion || 'Kh√¥ng c√≥ xung ƒë·ªôt'}</td>
            `;
            resultBody.appendChild(row);
        });

        // Th√™m d√≤ng ph√¢n c√°ch
        if (group.length > 0) {
            const separator = document.createElement('tr');
            separator.innerHTML = '<td colspan="8" class="group-separator"></td>';
            resultBody.appendChild(separator);
        }
    });

    // N·∫øu kh√¥ng c√≥ nh√≥m n√†o th√¨ th√™m d√≤ng b√°o "Kh√¥ng c√≥ l·ªói"
    if (conflictGroups.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            
                <td colspan="5"class="herb-row conflict-row">Kh√¥ng c√≥ l·ªói n√†o ƒë∆∞·ª£c ghi nh·∫≠n</td>
        `;
        resultBody.appendChild(row);
    }

    // ===== 2. L·ªåC V√Ä HI·ªÇN TH·ªä B·∫¢NG L·ªñI =====
const operatorError = document.getElementById('operatorSelectError').value;
 const filteredErrors = operatorError === 'all' 
   ? errorLog 
   : errorLog.filter(error =>
       error.details &&
      error.details.operator &&
       error.details.operator.replace(/,/g, '') === operatorError.replace(/,/g, '')
    );

    // Hi·ªÉn th·ªã l·ªói ƒë√£ l·ªçc
    const errorLogDiv = document.getElementById('errorLog');
    if (filteredErrors.length === 0) {
        errorLogDiv.innerHTML = `<table class="error-table">
        <thead>
            <tr>
              <th><i class="fas fa-user fa-spin-continuous"></i> T√™n BN</th>
            <th><i class="fas fa-procedures fa-spin-continuous"></i> Th·ªß thu·∫≠t</th>
            <th><i class="fas fa-user-nurse fa-spin-continuous"></i> Ng∆∞·ªùi th·ª±c hi·ªán</th>
            <th><i class="far fa-clock fa-spin-continuous"></i> Th·ªùi gian</th>
            <th><i class="fas fa-exclamation-triangle fa-spin-continuous"></i> L·ªói</th>
            </tr>
        </thead>
        <tbody> <tr class="error-row">
                <td colspan="5" class="error-detail">Kh√¥ng c√≥ l·ªói n√†o ƒë∆∞·ª£c ghi nh·∫≠n</td></tr></tbody></table>`;
        return;
    }

    let html = `
    <table class="error-table">
        <thead>
            <tr>
              <th><i class="fas fa-user fa-spin-continuous"></i> T√™n BN</th>
            <th><i class="fas fa-procedures fa-spin-continuous"></i> Th·ªß thu·∫≠t</th>
            <th class="doctor-column"><i class="fas fa-user-md fa-spin-continuous"></i> B√°c s·ªπ ch·ªâ ƒë·ªãnh</th>
            <th><i class="fas fa-user-nurse fa-spin-continuous"></i> Ng∆∞·ªùi th·ª±c hi·ªán</th>
            <th><i class="far fa-clock fa-spin-continuous"></i> Th·ªùi gian</th>
            <th><i class="fas fa-exclamation-triangle fa-spin-continuous"></i> L·ªói</th>
            </tr>
        </thead>
        <tbody>`;

    filteredErrors.forEach(error => {
        if (error.details) {
            html += `
            <tr class="error-row">
                <td>${error.details.patientName || 'Kh√¥ng c√≥'}</td>
                <td>${error.details.procedure || 'Kh√¥ng c√≥'}</td>
				<td class="doctor-column">${error.details.doctor || 'Kh√¥ng c√≥'}</td>
                <td>${error.details.operator ? error.details.operator.replace(/,/g, '') : 'Kh√¥ng c√≥'}</td>
                <td><center>${error.details.ngayThucHien || (error.details.date || 'Kh√¥ng c√≥')} <br/>${
                    error.details.startTime ? `${error.details.startTime} - ${error.details.endTime}` : 'Kh√¥ng c√≥'
                }</center></td>
                <td class="error-detail">
                    ${error.message}
                    ${error.details.expected ? `${error.details.actual} ph√∫t (Quy ƒë·ªãnh: ${error.details.expected} ph√∫t)` : ''}
                </td>
            </tr>`;
        } else {
            html += `
            <tr class="error-row">
                <td colspan="5" class="error-detail">
                    ${error.message} ${error.row ? '(D√≤ng ' + error.row + ')' : ''}
                </td>
            </tr>`;
        }
    });

    html += `</tbody></table>`;
    errorLogDiv.innerHTML = html;
}

function displayFilteredErrors(filteredErrors) {
    const errorLogDiv = document.getElementById('errorLog');
    
    if (filteredErrors.length === 0) {
        errorLogDiv.innerHTML = '<p>Kh√¥ng c√≥ l·ªói n√†o ƒë∆∞·ª£c ghi nh·∫≠n</p>';
        return;
    }
    
    let html = `
    <table class="error-table">
        <thead>
            <tr>
               <th><i class="fas fa-user fa-spin-continuous"></i> T√™n BN</th>
            <th><i class="fas fa-procedures fa-spin-continuous"></i> Th·ªß thu·∫≠t</th>
            <th class="doctor-column"><i class="fas fa-user-md fa-spin-continuous"></i> B√°c s·ªπ ch·ªâ ƒë·ªãnh</th>
            <th><i class="fas fa-user-nurse fa-spin-continuous"></i> Ng∆∞·ªùi th·ª±c hi·ªán</th>
            <th><i class="far fa-clock fa-spin-continuous"></i> Th·ªùi gian</th>
            <th><i class="fas fa-exclamation-triangle fa-spin-continuous"></i> L·ªói</th>
            </tr>
        </thead>
        <tbody>`;
    
    filteredErrors.forEach(error => {
        if (error.details) {
            html += `
            <tr class="error-row">
                <td>${error.details.patientName || 'Kh√¥ng c√≥'}</td>
                <td>${error.details.procedure || 'Kh√¥ng c√≥'}</td>
                <td>${error.details.operator ? error.details.operator.replace(/,/g, '') : 'Kh√¥ng c√≥'}</td>
                <td><center>${error.details.ngayThucHien || (error.details.date || 'Kh√¥ng c√≥')} <br/>${error.details.startTime ? `${error.details.startTime} - ${error.details.endTime}` : 'Kh√¥ng c√≥'}</center></td>
                <td class="error-detail">
                    ${error.message}
                    ${error.details.expected ? `${error.details.actual} ph√∫t   (Quy ƒë·ªãnh: ${error.details.expected} ph√∫t)` : ''}
                </td>
            </tr>`;
        } else {
            html += `
            <tr class="error-row">
                <td colspan="6" class="error-detail">
                    ${error.message} ${error.row ? '(D√≤ng ' + error.row + ')' : ''}
                </td>
            </tr>`;
        }
    });
    
    html += `</tbody></table>`;
    errorLogDiv.innerHTML = html;
}

        function logError(message, row = null, details = null) {
            errorLog.push({
                message,
                row,
                details,
                timestamp: new Date().toLocaleTimeString(),
                user: currentUser
            });
        }

function displayErrors() {
    const errorLogDiv = document.getElementById('errorLog');
    
    if (errorLog.length === 0) {
        errorLogDiv.innerHTML = '<p>Kh√¥ng c√≥ l·ªói n√†o ƒë∆∞·ª£c ghi nh·∫≠n</p>';
        document.getElementById('errorSection').style.display = 'none';
        
        // N·∫øu kh√¥ng c√≥ l·ªói, cu·ªôn xu·ªëng ph·∫ßn K·∫øt Qu·∫£ Ki·ªÉm Tra
        setTimeout(() => {
            const resultSection = document.getElementById('resultSection');
            if (resultSection && resultSection.style.display !== 'none') {
                smoothScrollTo(resultSection, -40);
            }
        }, 300);
        return;
    }
    
    let html = `
    <table class="error-table">
        <thead>
            <tr>
             <th><i class="fas fa-user fa-spin-continuous"></i> T√™n BN</th>
            <th><i class="fas fa-procedures fa-spin-continuous"></i> Th·ªß thu·∫≠t</th>
            <th class="doctor-column"><i class="fas fa-user-md fa-spin-continuous"></i> B√°c s·ªπ ch·ªâ ƒë·ªãnh</th>
            <th><i class="fas fa-user-nurse fa-spin-continuous"></i> Ng∆∞·ªùi th·ª±c hi·ªán</th>
            <th><i class="far fa-clock fa-spin-continuous"></i> Th·ªùi gian</th>
            <th><i class="fas fa-exclamation-triangle fa-spin-continuous"></i> L·ªói</th>
            </tr>
        </thead>
        <tbody>`;
    
    // Hi·ªÉn th·ªã t·ª´ng l·ªói
    errorLog.forEach(error => {
        if (error.details) {
            html += `
            <tr class="error-row">
                <td>${error.details.patientName || 'Kh√¥ng c√≥'}</td>
                <td>${error.details.procedure || 'Kh√¥ng c√≥'}</td>
                <td class="doctor-column">${error.details.doctor || 'Kh√¥ng c√≥'}</td>
                <td>${error.details.operator ? error.details.operator.replace(/,/g, '') : 'Kh√¥ng c√≥'}</td>
                <td><center>${error.details.ngayThucHien || (error.details.date || 'Kh√¥ng c√≥')} <br/>${error.details.startTime ? `${error.details.startTime} - ${error.details.endTime}` : 'Kh√¥ng c√≥'}</center></td>
                <td class="error-detail">
                    ${error.message}
                    ${error.details.expected ? `${error.details.actual} ph√∫t   (Quy ƒë·ªãnh: ${error.details.expected} ph√∫t)` : ''}
                </td>
            </tr>`;
        } else {
            html += `
            <tr class="error-row">
                <td colspan="6" class="error-detail">
                    ${error.message} ${error.row ? '(D√≤ng ' + error.row + ')' : ''}
                </td>
            </tr>`;
        }
    });
    
    html += `</tbody></table>`;
    
    errorLogDiv.innerHTML = html;
   document.getElementById('errorSection').style.display = 'block';
    
    // Cu·ªôn xu·ªëng ph·∫ßn l·ªói n·∫øu c√≥
    setTimeout(() => {
        const errorSection = document.getElementById('errorSection');
        if (errorSection) {
            smoothScrollTo(errorSection, -130);
        }
    }, 300);
}

// H√†m cu·ªôn m∆∞·ª£t t·ªïng qu√°t
function smoothScrollTo(element, offset = 0) {
    element.classList.add('highlight-error-section');
    
    const elementPosition = element.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - offset;
    
    const duration = 1500;
    const start = window.pageYOffset;
    const startTime = performance.now();
    
    function scrollStep(timestamp) {
        const elapsed = timestamp - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easing = easeInOutCubic(progress);
        window.scrollTo(0, start + (offsetPosition - start) * easing);
        
        if (progress < 1) {
            window.requestAnimationFrame(scrollStep);
        }
    }
    
    function easeInOutCubic(t) {
        return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
    }
    
    window.requestAnimationFrame(scrollStep);
    
    setTimeout(() => {
        element.classList.remove('highlight-error-section');
    }, 2000);
}


 

        function parseDateTime(datetimeStr, rowIndex) {
            try {
                if (!datetimeStr) {
                  
                    return null;
                }
                
                if (typeof datetimeStr === 'number') {
                    const excelDate = new Date(Math.round((datetimeStr - 25569) * 86400 * 1000));
                    const day = excelDate.getDate();
                    const month = excelDate.getMonth() + 1;
                    const year = excelDate.getFullYear();
                    const hours = excelDate.getHours();
                    const minutes = excelDate.getMinutes();
                    const seconds = excelDate.getSeconds();
                    
                    return {
                        dateObj: excelDate,
                        dateKey: `${day}/${month}/${year}`,
                        minutes: hours * 60 + minutes,
                        seconds: hours * 3600 + minutes * 60 + seconds,
                        displayTime: `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
                    };
                } 
                
                if (typeof datetimeStr === 'string') {
                    let datePart, timePart = '00:00:00';
                    if (datetimeStr.includes(' ')) [datePart, timePart] = datetimeStr.split(' ');
                    else datePart = datetimeStr;
                    
                    let day, month, year;
                    if (datePart.includes('/')) {
                        const parts = datePart.split('/');
                        if (parts.length === 3) [day, month, year] = parts.map(Number);
                        else if (parts.length === 2) [day, month] = parts.map(Number), year = new Date().getFullYear();
                    } else if (datePart.includes('-')) {
                        const parts = datePart.split('-');
                        if (parts.length === 3) [year, month, day] = parts.map(Number);
                        else if (parts.length === 2) [month, day] = parts.map(Number), year = new Date().getFullYear();
                    } else throw new Error('ƒê·ªãnh d·∫°ng ng√†y kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£');
                    
                    if (isNaN(day) || isNaN(month) || isNaN(year) || day < 1 || day > 31 || month < 1 || month > 12) {
                        throw new Error('Gi√° tr·ªã ng√†y kh√¥ng h·ª£p l·ªá');
                    }
                    
                    let hours = 0, minutes = 0, seconds = 0;
                    if (timePart.includes(':')) {
                        const timeParts = timePart.split(':');
                        hours = parseInt(timeParts[0]) || 0;
                        minutes = parseInt(timeParts[1]) || 0;
                        seconds = parseInt(timeParts[2]) || 0;
                        
                        if (isNaN(hours) || isNaN(minutes) || isNaN(seconds) || 
                            hours < 0 || hours > 23 || minutes < 0 || minutes > 59 || seconds < 0 || seconds > 59) {
                            logError('Gi√° tr·ªã th·ªùi gian kh√¥ng h·ª£p l·ªá', rowIndex, { time: timePart });
                            hours = 0; minutes = 0; seconds = 0;
                        }
                    }
                    
                    const dateObj = new Date(year, month - 1, day, hours, minutes, seconds);
                    if (isNaN(dateObj.getTime())) throw new Error('Ng√†y kh√¥ng h·ª£p l·ªá');
                    
                    const secondsInDay = hours * 3600 + minutes * 60 + seconds;
                    const minutesInDay = hours * 60 + minutes;
                    
                    return {
                        dateObj,
                        dateKey: `${day}/${month}/${year}`,
                        minutes: minutesInDay,
                        seconds: secondsInDay,
                        displayTime: `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`
                    };
                }
                
                throw new Error('ƒê·ªãnh d·∫°ng th·ªùi gian kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£');
            } catch (error) {
                logError(`L·ªói ph√¢n t√≠ch th·ªùi gian: ${error.message}`, rowIndex, { 
                    value: datetimeStr,
                    errorDetails: error.stack 
                });
                return null;
            }
        }

        // ========== KH·ªûI T·∫†O S·ª∞ KI·ªÜN ========== //
        document.addEventListener('DOMContentLoaded', function() {
		document.getElementById('usernameInput').focus();
            // Khi trang load
            if (!sessionStorage.getItem('medUser')) {
                document.body.classList.add('login-page');
            }
            
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p khi trang t·∫£i
		
			
            checkSavedLogin();
            
            // G√°n s·ª± ki·ªán cho n√∫t ƒëƒÉng nh·∫≠p
            document.getElementById('loginBtn').addEventListener('click', () => {
    isLoginAction = true; // ‚úÖ Th√™m d√≤ng n√†y
    checkLogin();
});
            
            // G√°n s·ª± ki·ªán cho n√∫t ƒëƒÉng xu·∫•t
            document.getElementById('logoutBtn').addEventListener('click', () => {
    isLoginAction = false; // ‚úÖ Th√™m d√≤ng n√†y
    logout();
});

            
            // ƒêƒÉng nh·∫≠p b·∫±ng ph√≠m Enter
            document.getElementById('passwordInput').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    checkLogin();
                }
            });
            
            // G√°n s·ª± ki·ªán cho n√∫t ph√¢n t√≠ch file
            
document.getElementById('analyzeBtn').addEventListener('click', async () => {
  await ensureXLSX(); // n·∫°p XLSX ƒë√∫ng l√∫c d√πng
    const file = document.getElementById('fileInput').files[0];
if (!file) {
    const popup = document.getElementById('loadingPopup');
    const loadingText = document.getElementById('loadingText');
    const progressBar = document.getElementById('progressBar');

    loadingText.innerHTML = `
        <i class="fas fa-exclamation-triangle" style="font-size:24px;color:red;margin-bottom:10px;"></i><br/>
        <strong>Vui l√≤ng ch·ªçn file tr∆∞·ªõc khi ki·ªÉm tra</strong><br/><br/>
        <button class="btn" onclick="document.getElementById('loadingPopup').style.display='none'">ƒê√≥ng</button>
    `;
    progressBar.style.width = '0%';
    
    popup.style.display = 'flex';
    popup.classList.add('show');
    return;
}


    const popup = document.getElementById('loadingPopup');
    const loadingText = document.getElementById('loadingText');
    const progressBar = document.getElementById('progressBar');

    popup.style.display = 'flex';
    requestAnimationFrame(() => popup.classList.add('show'));

    loadingText.innerHTML = '<i class="fas fa-paper-plane" style="font-size:24px;color:#3498db;margin-bottom:10px;"></i><br/>ƒêang g·ª≠i d·ªØ li·ªáu v·ªÅ m√°y ch·ªß...';
    progressBar.style.width = '33%';
	
	
	
	const progressBarContainer = document.getElementById('progressBarContainer');

// Ch·ªâ t·∫°o 1 l·∫ßn
if (!document.getElementById('creditLineBelow')) {
  const credit = document.createElement('div');
  credit.id = 'creditLineBelow';
  credit.innerText = '¬© Thi·∫øt k·∫ø & ph√°t tri·ªÉn b·ªüi Ch√¢u Hu·ª≥nh';
  credit.style.marginTop = '10px';
  credit.style.fontSize = '16px';
  credit.style.color = '#FF0000';
  credit.style.textAlign = 'center';

  progressBarContainer.parentNode.insertBefore(credit, progressBarContainer.nextSibling);
}
	
	
	
	
    await new Promise(resolve => requestAnimationFrame(() => setTimeout(resolve, 50)));
    await new Promise(resolve => setTimeout(resolve, 700));

    progressBar.style.width = '66%';

    let total = 0;
    try {
        const fileReader = new FileReader();
        const data = await new Promise((resolve, reject) => {
            fileReader.onload = e => resolve(new Uint8Array(e.target.result));
            fileReader.onerror = () => reject(new Error("L·ªói ƒë·ªçc file"));
            fileReader.readAsArrayBuffer(file);
        });

        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[1]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
            header: 1,
            defval: "",
            blankrows: true
        });

        const rows = jsonData.slice(9);
        total = rows.length;
    } catch {
        total = 1000;
    }

    const step = 100;
    const steps = Math.ceil(total / step);
    const interval = 2600 / steps;

    for (let i = 1; i <= steps; i++) {
        const current = Math.min(i * step, total);
        loadingText.innerHTML = '<i class="fas fa-user-md" style="font-size:24px;color:#2980b9;margin-bottom:10px;"></i><br/>ƒêang ph√¢n t√≠ch d·ªØ li·ªáu t·ª´ng b·ªánh nh√¢n...<br>' + current + ' / ' + total;
        await new Promise(r => setTimeout(r, interval));
    }

    loadingText.innerHTML = '<i class="fas fa-check-circle" style="font-size:24px;color:green;margin-bottom:10px;"></i><br/>ƒê√£ ki·ªÉm tra xong...';
    progressBar.style.width = '100%';
    await new Promise(resolve => setTimeout(resolve, 1000));

if (!window.isKhoaLoi) {
    popup.classList.remove('show');
    setTimeout(() => { popup.style.display = 'none'; }, 500);


}



 else {
    // N·∫øu ƒëang l·ªói Khoa, KH√îNG ƒë∆∞·ª£c ·∫©n popup
    popup.classList.add('show');
    popup.style.display = 'flex';
}
    handleFile();
	
	
	
	
setTimeout(() => {
    // ‚ùå N·∫øu ƒëang l·ªói t√™n khoa th√¨ gi·ªØ nguy√™n popup, KH√îNG ƒë∆∞·ª£c ·∫©n, KH√îNG hi·ªán n√∫t
    if (window.isKhoaLoi) {
        popup.style.display = 'flex';
        popup.classList.add('show');
        return;
    }

    // ‚úÖ N·∫øu kh√¥ng l·ªói, th√¨ ·∫©n popup v√† hi·ªán n√∫t ch·ª©c nƒÉng
    popup.classList.remove('show');
    popup.style.display = 'none';

    document.querySelectorAll('button.btn').forEach(btn => {
        if (btn.textContent.includes('Gi·ªù tr·ªëng') || btn.textContent.includes('S·∫Øc thu·ªëc thang')) {
            btn.style.display = 'inline-block';
        }
    });
}, 500);


	
});

            
            // G√°n s·ª± ki·ªán cho dropdown l·ªçc
            document.getElementById('operatorSelect').addEventListener('change', filterByOperator);
            
			
			document.getElementById('showDoctorCheckbox').addEventListener('change', filterByOperator);
			
			
            // G√°n s·ª± ki·ªán cho radio button ch·ªçn khung gi·ªù
            document.querySelectorAll('input[name="timeOption"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (allProcedures.length > 0) {
                        generateTimeSuggestions(allProcedures);
                        filterByOperator();
                    }
                });
            });
			
			document.getElementById('operatorSelect').addEventListener('change', function() {
    filterByOperator();
});

 document.getElementById('operatorSelectError').addEventListener('change', function () {
   // ch·ªâ render l·∫°i, KH√îNG ƒë·ª•ng dropdown b√™n kia
   filterByOperator();
 });
			
        });
    </script>
<div class="procedure-info"><center> 
Design By <a href="http://fb.com/chauhuynh0104" target="_blank"> Dr.Ch√¢u</a><br/>
                N·∫øu C√≥ B·∫•t K·ª≥ V∆∞·ªõng M·∫Øc G√¨ Vui L√≤ng LH : <br/>
                Email: chauhuynh0104@gmail.com<br/>
                SDT: 079.567.9350</center>
</div>
<script>
  // H·ªó tr·ª£ nh·∫•n Enter t·ª´ √¥ username ho·∫∑c password
  document.getElementById('usernameInput').addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
      document.getElementById('passwordInput').focus();
    }
  });

  document.getElementById('passwordInput').addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
      document.getElementById('loginBtn').click();
    }
  });

// ====== T·ª∞ ƒê·ªòNG QU√âT TH∆Ø M·ª§C & CH·ªåN FILE M·ªöI NH·∫§T ======

document.getElementById('folderBtn').addEventListener('click', () => {
    document.getElementById('folderInput').click();
});

document.getElementById('folderInput').addEventListener('change', async (e) => {
 await ensureXLSX(); // n·∫°p XLSX tr∆∞·ªõc khi ƒë·ªçc workbook
    const files = Array.from(e.target.files).filter(f => /\.(xlsx|xls|csv)$/i.test(f.name));
    const statusDiv = document.getElementById('scanStatus');
    const fileInput = document.getElementById('fileInput');

    if (files.length === 0) {
        statusDiv.style.color = 'red';
        statusDiv.innerHTML = 'Kh√¥ng t√¨m th·∫•y file Excel h·ª£p l·ªá trong th∆∞ m·ª•c.';
        return;
    }

    let validFile = null;

    for (const file of files.sort((a, b) => b.lastModified - a.lastModified)) {
        try {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });

            if (!workbook.SheetNames[1]) continue; // c·∫ßn Sheet th·ª© 2

            const sheet = workbook.Sheets[workbook.SheetNames[1]];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "", blankrows: true });

            if (jsonData.length >= 10) { // √≠t nh·∫•t 2 d√≤ng header v√† c√≥ d·ªØ li·ªáu d√≤ng 10
                validFile = file;
                break;
            }
        } catch (err) {
            console.error(`L·ªói ƒë·ªçc file ${file.name}:`, err);
        }
    }

    if (validFile) {
        const dt = new DataTransfer();
        dt.items.add(validFile);
        fileInput.files = dt.files;

        // c·∫≠p nh·∫≠t tr·∫°ng th√°i
        statusDiv.innerHTML = `<i class="fas fa-folder-open"></i> ƒê√£ ch·ªçn file: <b>${validFile.name}</b>`;
        statusDiv.style.display = 'block';
        statusDiv.style.color = '#2c3e50';

        // G·ªçi ki·ªÉm tra
        document.getElementById('analyzeBtn').click();
    } else {
        statusDiv.style.color = 'red';
        statusDiv.innerHTML = 'Kh√¥ng t√¨m ƒë∆∞·ª£c file c√≥ c·∫•u tr√∫c h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.';
    }
});


</script>
<div class="toast" id="toast"></div>
<!-- Popup loading -->
<div id="loadingPopup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center;font-family:'Inter',sans-serif">
<div style="background:#fff;padding:30px 40px;border-radius:10px;text-align:center;box-shadow:0 0 15px rgba(0,0,0,0.3);max-width:90%;font-size:18px">
<div id="loadingText">
<i class="fas fa-spinner fa-spin" style="font-size:24px;color:#3498db;margin-bottom:10px;"></i><br/>
      ƒêang g·ª≠i d·ªØ li·ªáu v·ªÅ m√°y ch·ªß...
    </div>
<div id="progressBarContainer">
<div id="progressBar"></div>
<div id="availabilityTable" style="display: none; margin-top: 20px;">
  <h2>Th·ªëng k√™ gi·ªù tr·ªëng t·ª´ng ng∆∞·ªùi</h2>
  <table class="error-table">
    <thead>
      <tr>
        <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
        <th>Ng√†y</th>
        
        <th>Gi·ªù tr·ªëng bu·ªïi s√°ng</th>
        <th>Gi·ªù tr·ªëng bu·ªïi chi·ªÅu</th>
      </tr>
    </thead>
    <tbody id="availabilityBody"></tbody>
  </table>
</div>
<!-- K·∫æT TH√öC: B·∫¢NG GI·ªú TR·ªêNG T·ª™NG NG∆Ø·ªúI -->
</div>
</div>
</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const noidung = document.getElementById("noidung");
  const list1 = document.querySelector(".list1");

  if (noidung && list1) {
    const text = noidung.textContent || noidung.innerText || "";
    if (text.trim() === "") {
      list1.style.display = "none";
    }
  }
});

// ==== T√çNH TO√ÅN GI·ªú TR·ªêNG CHO T·ª™NG NG∆Ø·ªúI ====



function toggleAvailability() {
    const table = document.getElementById('availabilityTable');
    const filterBlock = document.getElementById('availabilityFilterBlock');
    if (table.style.display === 'none') {
        table.style.display = 'block';
        if (filterBlock) filterBlock.style.display = 'block';
        calculateAvailability();
    } else {
        table.style.display = 'none';
        if (filterBlock) filterBlock.style.display = 'none';
    }
}


function calculateAvailability() {
    const groups = {};
    allProcedures.forEach(proc => {
        const key = `${proc.operator}_${proc.date}`;
        if (!groups[key]) groups[key] = [];
        groups[key].push(proc);
    });

    const tbody = document.getElementById('availabilityBody');
    tbody.innerHTML = '';

    const selectedOp = document.getElementById('filterOperator')?.value || 'all';
    const selectedDate = document.getElementById('filterDate')?.value || 'all';

    // Ch·ªâ kh·ªüi t·∫°o dropdown 1 l·∫ßn
    if (!document.getElementById('filterOperator').dataset.initialized) {
        const operators = [...new Set(allProcedures.map(p => p.operator))].sort();
        const dates = [...new Set(allProcedures.map(p => p.date))].sort((a, b) => {
            const [da, ma, ya] = a.split('/').map(Number);
            const [db, mb, yb] = b.split('/').map(Number);
            return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
        });

        const opSelect = document.getElementById('filterOperator');
        const dateSelect = document.getElementById('filterDate');

        opSelect.innerHTML = '<option value="all">T·∫•t c·∫£</option>' +
            operators.map(op => `<option value="${op}">${op.replace(/,/g, '')}</option>`).join('');
        dateSelect.innerHTML = '<option value="all">T·∫•t c·∫£</option>' +
            dates.map(d => `<option value="${d}">${d}</option>`).join('');

        opSelect.dataset.initialized = 'true';
        dateSelect.dataset.initialized = 'true';

        opSelect.addEventListener('change', calculateAvailability);
        dateSelect.addEventListener('change', calculateAvailability);
    }

    Object.keys(groups).forEach(key => {
        const [operator, date] = key.split('_');
        if ((selectedOp !== 'all' && operator !== selectedOp) ||
            (selectedDate !== 'all' && date !== selectedDate)) return;

        const procedures = groups[key];
        procedures.sort((a, b) => a.start - b.start);

        const morningStart = 7 * 3600;
        const morningEnd = 11.5 * 3600;
        const afternoonStart = 13.5 * 3600;
        const afternoonEnd = 17 * 3600;

        const morningFree = getFreeSlots(procedures, morningStart, morningEnd);
        const afternoonFree = getFreeSlots(procedures, afternoonStart, afternoonEnd);

        const row = document.createElement('tr');
        row.classList.add("herb-row");
        row.innerHTML = `
            <td><a href="#" onclick="showProceduresForOperator(\`${operator}\`, \`${date}\`);return false;" style="color:#3498db;font-weight:bold">${operator.replace(/,/g, '')}</a></td>
            <td>${date}</td>
            <td>${morningFree}</td>
            <td>${afternoonFree}</td>
        `;
        tbody.appendChild(row);
    });
}


function getFreeSlots(procedures, start, end) {
    const busy = procedures.map(p => ({
        start: p.start,
        end: p.end + ((p.procedureInfo?.buffer || 0) * 60)
    })).filter(p => p.end > start && p.start < end);

    busy.sort((a, b) => a.start - b.start);

    const free = [];
    let cursor = start;

    for (const b of busy) {
        if (b.start > cursor && b.start > start && cursor < end) {
            const freeStart = Math.max(cursor, start);
            const freeEnd = Math.min(b.start, end);
            if (freeEnd > freeStart) {
                free.push(`${formatTime(freeStart)} - ${formatTime(freeEnd)}`);
            }
        }
        cursor = Math.max(cursor, b.end);
    }

    if (cursor < end) {
        free.push(`${formatTime(cursor)} - ${formatTime(end)}`);
    }

    return free.length ? free.join('<br>') : '<i>Kh√¥ng c√≤n tr·ªëng</i>';
}

function formatTime(sec) {
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    return h.toString().padStart(2, '0') + 'h' + m.toString().padStart(2, '0');
}

function showProceduresForOperator(operator, date) {
    const overlay = document.getElementById('procedureOverlay');
    const content = document.getElementById('popupContent');
    const list = allProcedures.filter(p => p.operator === operator && p.date === date);

    if (list.length === 0) {
        content.innerHTML = "<i>Kh√¥ng t√¨m th·∫•y th·ªß thu·∫≠t</i>";
    } else {
        list.sort((a, b) => a.start - b.start);
        content.innerHTML = "<b>Ng∆∞·ªùi th·ª±c hi·ªán:</b> " + operator + "<br><b>Ng√†y:</b> " + date + "<br><br>" +
            "<ul style='padding-left:20px'>" + list.map(p => 
                "<li><b>" + p.patientName + "</b> - " + p.procedure + " (" + p.displayStart + " ‚Üí " + p.displayEnd + ")</li>"
            ).join('') + "</ul>";
    }

    overlay.style.display = 'block';
}

function closeProcedurePopup() {
    document.getElementById('procedureOverlay').style.display = 'none';
}
</script>
<!-- Popup th·ªß thu·∫≠t chi ti·∫øt v·ªõi overlay -->
<div id="procedureOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:10000" onclick="closeProcedurePopup()">
  <div id="procedurePopup" onclick="event.stopPropagation()" style="position:relative;top:10%;left:50%;transform:translateX(-50%);background:#fff;color:#000;border:2px solid #3498db;padding:20px;border-radius:8px;box-shadow:0 5px 20px rgba(0,0,0,0.3);max-height:70vh;overflow:auto;font-family:Inter,sans-serif;max-width:600px">
    <h3>Chi ti·∫øt th·ªß thu·∫≠t</h3>
    <div id="popupContent"></div>
    <br/>
    <button class="btn" onclick="closeProcedurePopup()">ƒê√≥ng</button>
  </div>
</div>





<script>
function renderHerbList() {
    const tbody = document.getElementById('herbTableBody');
    tbody.innerHTML = '';

    const herbs = window.allHerbProcedures || [];
    const dateFilter = document.getElementById('herbDateFilter');
    const doctorFilter = document.getElementById('herbDoctorFilter');

    if (!dateFilter.dataset.initialized) {
        const uniqueDates = [...new Set(herbs.map(h => h.date))].sort((a, b) => {
            const [da, ma, ya] = a.split('/').map(Number);
            const [db, mb, yb] = b.split('/').map(Number);
            return new Date(ya, ma - 1, da) - new Date(yb, mb - 1, db);
        });

        const uniqueDoctors = [...new Set(herbs.map(h => h.doctor || 'Kh√¥ng c√≥'))].sort();

        dateFilter.innerHTML = '<option value="all">T·∫•t c·∫£</option>' +
            uniqueDates.map(d => `<option value="${d}">${d}</option>`).join('');

        doctorFilter.innerHTML = '<option value="all">T·∫•t c·∫£ b√°c sƒ©</option>' +
            uniqueDoctors.map(d => `<option value="${d}">${d}</option>`).join('');

        dateFilter.dataset.initialized = "true";
        dateFilter.addEventListener('change', renderHerbList);
        doctorFilter.addEventListener('change', renderHerbList);
    }

    const selectedDate = dateFilter.value;
    const selectedDoctor = doctorFilter.value;

    const filteredHerbs = herbs.filter(p =>
        (selectedDate === 'all' || p.date === selectedDate) &&
        (selectedDoctor === 'all' || p.doctor === selectedDoctor)
    );

    if (filteredHerbs.length === 0) {
        const row = document.createElement('tr');
        row.classList.add("herb-row");
        row.innerHTML = `<td colspan="5"><center>Kh√¥ng c√≥ d·ªØ li·ªáu s·∫Øc thu·ªëc thang</center></td>`;
        tbody.appendChild(row);
        return;
    }

    filteredHerbs.forEach(p => {
        const row = document.createElement('tr');
        row.classList.add("herb-row");
        row.innerHTML = `
            <td>${p.patientName}</td>
            <td>${p.procedure}</td>
            <td>${p.date}</td>
            <td>${p.displayStart} ‚Üí ${p.displayEnd}</td>
            <td>${p.operator.replace(/,/g, '')}</td>
        `;
        tbody.appendChild(row);
    });
}


function toggleHerbList() {
    const table = document.getElementById('herbProcedureTable');
    if (table.style.display === 'none') {
        table.style.display = 'block';
        renderHerbList();
    } else {
        table.style.display = 'none';
    }
}
</script>



<script>
(function(){
  /* ==== TI·ªÜN √çCH CHU·∫®N HO√Å T√äN ==== */
  function cleanDisplay(name){
    return (name||'')
      .toString()
      .replace(/[,Ôºå]+\s*$/,'')
      .replace(/\s+/g,' ')
      .trim();
  }
  function norm(name){
    return cleanDisplay(name).toLowerCase();
  }

  /* ==== T√çNH ƒêA S·ªê THEO NG√ÄY ==== */
  function computeMajorityByDate(rows){
    const map = Object.create(null);
    rows.forEach(r=>{
      const d = r.date;
      const n = norm(r.operator);
      if(!n || n === 'kh√¥ng c√≥') return;
      (map[d]||(map[d]={}))[n] = (map[d][n]||0)+1;
    });
    const out = {};
    Object.keys(map).forEach(d=>{
      const arr = Object.entries(map[d]).sort((a,b)=>b[1]-a[1]);
      const top = arr[0] || [null,0];
      const second = arr[1] || [null,0];
      out[d] = { topNorm:top[0], topCount:top[1], secondCount:second[1] };
    });
    return out;
  }

  /* ==== UI PH·ª§: T√ìM T·∫ÆT + POPUP ==== */
  function ensureOutlierUI(){
    const summary = document.getElementById('herbOutlierSummary');
    const modal   = document.getElementById('herbOutlierModal');
    if(!summary) console.warn('Thi·∫øu #herbOutlierSummary trong HTML!');
    if(!modal)   console.warn('Thi·∫øu #herbOutlierModal trong HTML!');
    const btn = document.getElementById('herbOutlierCloseBtn');
    const backdrop = document.getElementById('herbOutlierBackdrop');
    if(btn) btn.addEventListener('click', ()=>modal.style.display='none');
    if(backdrop) backdrop.addEventListener('click', ()=>modal.style.display='none');
  }
  ensureOutlierUI();

  /* ==== GHI ƒê√à H√ÄM RENDER ==== */
  window.renderHerbList = function(){
    const tbody = document.getElementById('herbTableBody');
    const dateFilter = document.getElementById('herbDateFilter');
    const doctorFilter = document.getElementById('herbDoctorFilter');
    const summaryDiv = document.getElementById('herbOutlierSummary');
    const modal = document.getElementById('herbOutlierModal');
    const modalBody = document.getElementById('herbOutlierModalBody');
    const modalInfo = document.getElementById('herbOutlierModalInfo');

    tbody.innerHTML = '';

    const herbsRaw = window.allHerbProcedures || [];
    const herbs = herbsRaw.map(h=>({
      ...h,
      opClean: cleanDisplay(h.operator),
      opNorm: norm(h.operator)
    }));

    if(!dateFilter.dataset.initialized){
      const uniqueDates = [...new Set(herbs.map(h=>h.date))].sort((a,b)=>{
        const [da,ma,ya] = a.split('/').map(Number);
        const [db,mb,yb] = b.split('/').map(Number);
        return new Date(ya,ma-1,da) - new Date(yb,mb-1,db);
      });
      const uniqueDoctors = [...new Set(herbs.map(h=>h.doctor||'Kh√¥ng c√≥'))].sort();
      dateFilter.innerHTML =
        '<option value="all">T·∫•t c·∫£</option>' +
        uniqueDates.map(d=>`<option value="${d}">${d}</option>`).join('');
      doctorFilter.innerHTML =
        '<option value="all">T·∫•t c·∫£ b√°c sƒ©</option>' +
        uniqueDoctors.map(d=>`<option value="${d}">${d}</option>`).join('');
      dateFilter.dataset.initialized = 'true';
      dateFilter.addEventListener('change', window.renderHerbList);
      doctorFilter.addEventListener('change', window.renderHerbList);
    }

    const selectedDate = dateFilter.value;
    const selectedDoctor = doctorFilter.value;

    const filtered = herbs.filter(p =>
      (selectedDate === 'all' || p.date === selectedDate) &&
      (selectedDoctor === 'all' || p.doctor === selectedDoctor)
    );

    if(filtered.length === 0){
      const tr = document.createElement('tr');
      tr.className = 'herb-row';
      tr.innerHTML = '<td colspan="5"><center>Kh√¥ng c√≥ d·ªØ li·ªáu s·∫Øc thu·ªëc thang</center></td>';
      tbody.appendChild(tr);
      if(summaryDiv) summaryDiv.style.display='none';
      return;
    }

    const majority = computeMajorityByDate(herbs);
    const outliersInView = [];

    filtered.forEach(p=>{
      const tr = document.createElement('tr');
      tr.className = 'herb-row';
      const m = majority[p.date];
      const hasMajority = m && m.topNorm && m.topCount > m.secondCount;
      if(hasMajority && p.opNorm !== m.topNorm){
        tr.classList.add('herb-outlier');
        outliersInView.push(p);
      }
      tr.innerHTML = `
        <td>${p.patientName}</td>
        <td>${p.procedure}</td>
        <td>${p.date}</td>
        <td>${p.displayStart} &rarr; ${p.displayEnd}</td>
        <td>${p.opClean}</td>
      `;
      tbody.appendChild(tr);
    });

    if(summaryDiv){
      if(outliersInView.length){
        summaryDiv.style.display='block';
        summaryDiv.innerHTML =
          `<a href="#" id="herbOutlierCountLink">C√≥ ${outliersInView.length} ca c√≥ v·∫•n ƒë·ªÅ trong danh s√°ch n√†y.</a>`;
        const link = document.getElementById('herbOutlierCountLink');
        link.addEventListener('click', function(ev){
          ev.preventDefault();
          if(modalBody){
            modalBody.innerHTML = '';
            outliersInView.forEach(p=>{
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${p.patientName}</td>
                <td>${p.procedure}</td>
                <td>${p.date}</td>
                <td>${p.displayStart} &rarr; ${p.displayEnd}</td>
                <td>${p.opClean}</td>
              `;
              modalBody.appendChild(tr);
            });
          }
          if(modalInfo){
            const noteDate = (selectedDate==='all') ? 'nhi·ªÅu ng√†y' : selectedDate;
            modalInfo.textContent = `T·ªïng ${outliersInView.length} ca kh√°c ƒëa s·ªë (${noteDate}).`;
          }
          if(modal) modal.style.display='block';
        }, {once:true});
      } else {
        summaryDiv.style.display='none';
        summaryDiv.innerHTML='';
      }
    }
  };

  document.addEventListener('DOMContentLoaded', ()=>{
    const table = document.getElementById('herbProcedureTable');
    if(table && table.style.display !== 'none'){
      window.renderHerbList();
    }
  });
})();




</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const fileInput = document.getElementById('fileInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    if (fileInput && analyzeBtn) {
      fileInput.addEventListener('change', function () {
        analyzeBtn.click();
      });
    }
  });
</script>


<!-- THEME PICKER SCRIPT -->
<script>
(function(){
  const THEME_KEY = 'uiAccentTheme';
  const body = document.body;
  const picker = document.getElementById('themePicker');
  if(!picker) return;
  function applyTheme(t){
    body.classList.remove('theme-default','theme-orange','theme-red','theme-green');
    if(t && t !== 'default'){
      body.classList.add('theme-'+t);
    } else {
      body.classList.add('theme-default'); // explicit ƒë·ªÉ active ring
    }
    picker.querySelectorAll('.theme-swatch').forEach(btn=>{
      btn.classList.toggle('is-active', btn.dataset.theme===t || (t==='' && btn.dataset.theme==='default'));
    });
    try{ localStorage.setItem(THEME_KEY,t||'default'); }catch(e){}
  }
  const saved = (function(){try{return localStorage.getItem(THEME_KEY) || 'default';}catch(e){return 'default';}})();
  applyTheme(saved);
  picker.addEventListener('click',e=>{
    const btn = e.target.closest('.theme-swatch');
    if(!btn) return;
    applyTheme(btn.dataset.theme);
  });
})();
</script>

<script>
function updateHerbButtonWithOutlierCount() {
  const btn = document.getElementById('herbToggleBtn');
  if (!btn || !window.allHerbProcedures) return;

  const herbs = window.allHerbProcedures;
  const counts = {};

  herbs.forEach(h => {
    const date = h.date;
    const key = date;
    if (!counts[key]) counts[key] = {};
    const name = (h.operator || 'Kh√¥ng c√≥').trim().toLowerCase();
    counts[key][name] = (counts[key][name] || 0) + 1;
  });

  let outlierCount = 0;

  Object.keys(counts).forEach(date => {
    const ops = counts[date];
    const entries = Object.entries(ops).sort((a, b) => b[1] - a[1]);
    const top = entries[0];
    if (!top) return;

    const topName = top[0];
    const topCount = top[1];

    for (const [name, count] of entries) {
      if (name !== topName && count > 0) {
        outlierCount += count;
      }
    }
  });

btn.innerHTML = `S·∫Øc thu·ªëc thang <i class="fa-solid fa-triangle-exclamation" style="color:yellow"></i> <span style="color:yellow; font-weight:bold">(${outlierCount})</span>`;


}
</script>
<div id="dropboxPanel" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="margin:5% auto; background:#fff; padding:20px; max-width:90%; border-radius:10px; max-height:80vh; overflow:auto">
   <div style="display: flex; justify-content: space-between; align-items: center;">
  <h3>üìÇ Danh s√°ch Khoa ƒë√£ s·ª≠ d·ª•ng ph·∫ßn m·ªÅm</h3>
  <button class="btn"onclick="document.getElementById('dropboxPanel').style.display='none'"style="padding:8px 14px; font-size:13px; border-radius:4px;">
    ƒê√≥ng
  </button>
</div>
<!-- Pagination controls -->
<div id="dropboxPager" style="display:flex;align-items:center;gap:8px;justify-content:space-between;margin-top:12px">
  <div>
    Hi·ªÉn th·ªã
    <select id="dropboxPageSize" style="padding:6px 8px;border:1px solid #ddd;border-radius:6px">
      <option value="10" selected>10</option>
      <option value="20">20</option>
      <option value="50">50</option>
    </select>
    d√≤ng / trang
  </div>

  <div id="dropboxPageButtons" style="display:flex;gap:6px;flex-wrap:wrap"></div>

  <div id="dropboxPageInfo" style="min-width:170px;text-align:right"></div>
</div>
    <table border="1" cellpadding="8" style="width:100%; border-collapse:collapse; font-size:14px">
      <thead>
        <tr>
          <th>STT</th>
          <th>T√™n khoa</th>
          <th>Ng√†y</th>
          <th>S·∫Øc thu·ªëc</th>
         <th>Sai th·ªùi gian</th>
       <th>Tr√πng gi·ªù</th>
       
          <th>Th·ªùi gian</th>
		  <th>Link</th>
		  <th>Xo√°</th>
        </tr>
      </thead>
      <tbody id="dropboxFileList"></tbody>
    </table>
  
  </div>
</div><script>
async function showDropboxPanel() {
await ensureDropbox(); // ƒë·∫£m b·∫£o c√≥ Dropbox SDK

  const accessToken = await getAccessToken();
  const dbx = new Dropbox.Dropbox({ accessToken });
  const tbody = document.getElementById('dropboxFileList');

  // Hi·ªán popup ngay l·∫≠p t·ª©c v·ªõi tr·∫°ng th√°i loading
  tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; color:blue;">
    ƒêang t·∫£i d·ªØ li·ªáu...
  </td></tr>`;
  document.getElementById('dropboxPanel').style.display = 'block';

  try {
    // 1) Ki·ªÉm tra t·ªìn t·∫°i log.json
    let hasLog = false;
    let res = await dbx.filesListFolder({ path: '/thuthuat' });
    while (true) {
      if (res.result?.entries?.some(e => e['.tag'] === 'file' && e.name === 'log.json')) {
        hasLog = true;
        break;
      }
      if (!res.result?.has_more) break;
      res = await dbx.filesListFolderContinue({ cursor: res.result.cursor });
    }

    // 2) N·∫øu kh√¥ng c√≥ file ‚Üí c·∫≠p nh·∫≠t n·ªôi dung
    if (!hasLog) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">
        Kh√¥ng c√≥ danh s√°ch n√†o ƒë∆∞·ª£c l∆∞u
      </td></tr>`;
      return;
    }

    // 3) C√≥ file ‚Üí t·∫£i v√† hi·ªÉn th·ªã
    const dl = await dbx.filesDownload({ path: '/thuthuat/log.json' });
    const text = await dl.result.fileBlob.text();
    let logs = [];
    try { logs = JSON.parse(text); } catch { logs = []; }

    if (!logs.length) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">
        Kh√¥ng c√≥ danh s√°ch n√†o ƒë∆∞·ª£c l∆∞u
      </td></tr>`;
    } else {
 const currentUser = (sessionStorage.getItem('medUser') || '').toLowerCase();

// Render m·ªõi ‚Äì giao cho b·ªô ph√¢n trang:
DB_LOGS = logs; // m·∫£ng d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß
DB_PAGE = 1;    // v·ªÅ trang 1 m·ªói khi m·ªü panel
DB_CURRENT_USER = (sessionStorage.getItem('medUser') || '').toLowerCase();

attachPagerEventsOnce(); // g·∫Øn change cho select page size (ch·ªâ 1 l·∫ßn)
renderDropboxPage();     // v·∫Ω tbody + n√∫t trang t·ª´ DB_LOGS
    }
  } catch (err) {
    console.error('L·ªói khi ƒë·ªçc danh s√°ch t·ª´ Dropbox:', err);
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">
      Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu
    </td></tr>`;
  }
}
(function(){
  const pager = document.getElementById('dropboxPager');
  if (pager && !pager.dataset.bound) {
    pager.dataset.bound = '1';
    pager.addEventListener('click', e => e.stopPropagation());
    pager.addEventListener('mousedown', e => e.stopPropagation());
  }
})();

</script>
<script>
function verifyAndOpenLink(url) {


  // Overlay t·ªëi (click v√†o s·∫Ω t·∫Øt)
  const overlay = document.createElement('div');
  Object.assign(overlay.style, {
    position: 'fixed', inset: '0', background: 'rgba(0,0,0,0.5)',
    display: 'flex', justifyContent: 'center', alignItems: 'center',
    zIndex: '10000'
  });

  // Khung popup
  const box = document.createElement('div');
  Object.assign(box.style, {
    background: '#fff', padding: '24px', borderRadius: '10px',
    maxWidth: '420px', width: '90%', boxShadow: '0 4px 10px rgba(0,0,0,0.3)',
    display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '12px'
  });

  // Ti√™u ƒë·ªÅ ng·∫Øn g·ªçn (kh√¥ng c√≥ icon/g·ª≠i d·ªØ li·ªáu)
  const title = document.createElement('div');
  title.textContent = 'Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü link';
  title.style.fontWeight = '600';

  // √î nh·∫≠p m·∫≠t kh·∫©u
  const input = document.createElement('input');
  Object.assign(input, { type: 'password', placeholder: 'M·∫≠t kh·∫©u' });
  Object.assign(input.style, {
    padding: '10px', width: '100%', border: '1px solid #ddd', borderRadius: '6px'
  });

  // Th√¥ng b√°o l·ªói (·∫©n m·∫∑c ƒë·ªãnh)
  const err = document.createElement('div');
  err.textContent = '‚ùå Sai m·∫≠t kh·∫©u!';
  Object.assign(err.style, { color: 'red', fontSize: '14px', display: 'none' });

  // N√∫t x√°c nh·∫≠n
  const btn = document.createElement('button');
  btn.textContent = 'X√°c nh·∫≠n';
  Object.assign(btn.style, {
    padding: '10px 16px', background: '#3498db', color: '#fff',
    border: 'none', borderRadius: '6px', cursor: 'pointer'
  });

  // Progress bar (ƒë·∫∑t D∆Ø·ªöI C√ôNG)
  const barWrap = document.createElement('div');
  Object.assign(barWrap.style, {
    width: '100%', background: '#ddd', height: '6px',
    borderRadius: '3px', marginTop: '12px'
  });
  const bar = document.createElement('div');
  Object.assign(bar.style, { width: '0%', height: '100%', background: '#3498db' });
  barWrap.appendChild(bar);

  // G·∫Øn v√†o DOM
  box.appendChild(title);
  box.appendChild(input);
  box.appendChild(err);
  box.appendChild(btn);
  box.appendChild(barWrap);
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  // Ch·∫∑n click b√™n trong kh√¥ng ƒë√≥ng
  box.addEventListener('click', e => e.stopPropagation());
  // Click ra ngo√†i ƒë·ªÉ t·∫Øt
  overlay.addEventListener('click', () => {
    document.body.removeChild(overlay);
  });

  // X·ª≠ l√Ω x√°c nh·∫≠n
  async function submit() {
    // ƒê·ªïi m·∫≠t kh·∫©u ·ªü ƒë√¢y
    const OK = input.value === '1!';

    if (!OK) {
      err.style.display = 'block';
      return;
    }
    err.style.display = 'none';
    btn.disabled = true;
    input.disabled = true;

    // Animate progress nhanh l√™n 100%
    bar.style.transition = 'width 0.6s ease';
    requestAnimationFrame(() => (bar.style.width = '100%'));
    setTimeout(() => {
      window.open(url, '_blank');
      if (overlay.parentNode) document.body.removeChild(overlay);
    }, 650);
  }

  btn.addEventListener('click', submit);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') submit();
  });

  // Focus ngay √¥ m·∫≠t kh·∫©u
  setTimeout(() => input.focus(), 0);
}

function extractFilename(dropboxPreviewUrl) {
  try {
    const u = new URL(dropboxPreviewUrl);
    const p = u.searchParams.get('preview');
    return decodeURIComponent(p || '');
  } catch { return ''; }
}

// H·ªôp x√°c nh·∫≠n xo√° (tr·∫£ v·ªÅ Promise<boolean>)
function confirmDeletePopup(text='B·∫°n c√≥ ch·∫Øc mu·ªën xo√°?', oneButton=false) {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    Object.assign(overlay.style, {
      position:'fixed', inset:'0', background:'rgba(0,0,0,0.5)',
      display:'flex', alignItems:'center', justifyContent:'center', zIndex:10001
    });

    const box = document.createElement('div');
    Object.assign(box.style, {
      background:'#fff', padding:'20px', borderRadius:'8px',
      maxWidth:'420px', width:'90%', boxShadow:'0 4px 12px rgba(0,0,0,.25)',
      fontFamily:'Inter, sans-serif'
    });

    box.innerHTML = `
      <div style="font-weight:600; margin-bottom:8px">X√°c nh·∫≠n xo√°</div>
      <div style="margin-bottom:14px">${text}</div>
      <div style="display:flex; gap:10px; justify-content:flex-end">
        <button id="dlgCancel" class="btn" style="background:#7f8c8d">Hu·ª∑</button>
        ${!oneButton ? `<button id="dlgYes" class="btn" style="background:#e74c3c">Xo√°</button>` : ''}
      </div>
    `;

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    box.addEventListener('click', e => e.stopPropagation());
    overlay.addEventListener('click', () => { document.body.removeChild(overlay); resolve(false); });
    box.querySelector('#dlgCancel').addEventListener('click', () => { document.body.removeChild(overlay); resolve(false); });

    if (!oneButton) {
      box.querySelector('#dlgYes').addEventListener('click', () => { document.body.removeChild(overlay); resolve(true); });
    }
  });
}

// Xo√° 1 entry log + file Excel tr√™n Dropbox (theo index trong m·∫£ng logs)
async function deleteLogAndFile_ByIndex(idx) {
  const accessToken = await getAccessToken();
  const dbx = new Dropbox.Dropbox({ accessToken });
  const logPath = '/thuthuat/log.json';

  // 1) T·∫£i log.json hi·ªán t·∫°i
  let logs = [];
  try {
    const dl = await dbx.filesDownload({ path: logPath });
    const text = await dl.result.fileBlob.text();
    logs = JSON.parse(text || '[]');
  } catch (e) {
    alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c log.json tr√™n Dropbox.'); 
    throw e;
  }

  const item = logs[idx];
  if (!item) { alert('Kh√¥ng t√¨m th·∫•y m·ª•c c·∫ßn xo√°.'); return; }

  // 2) L·∫•y fileName & xo√° file Excel (n·∫øu c√≥)
  const fileName = extractFilename(item.link || '');
  const filePath = fileName ? `/thuthuat/${fileName}` : null;

  try {
    if (filePath) { await dbx.filesDeleteV2({ path: filePath }); }
  } catch (e) {
    // N·∫øu file kh√¥ng t·ªìn t·∫°i v·∫´n ti·∫øp t·ª•c xo√° log
    console.warn('Xo√° file Excel l·ªói/kh√¥ng t·ªìn t·∫°i, ti·∫øp t·ª•c xo√° log...', e);
  }

  // 3) C·∫≠p nh·∫≠t log: b·ªè ph·∫ßn t·ª≠ idx v√† ghi ƒë√® l·∫°i
  logs.splice(idx, 1);
  await dbx.filesUpload({
    path: logPath,
    contents: JSON.stringify(logs, null, 2),
    mode: { '.tag': 'overwrite' },
    autorename: false
  });
}


async function onDeleteLogRow(indexInLogs, currentUser) {
  // N·∫øu kh√¥ng ph·∫£i doctor ‚Üí popup c·∫•m xo√°, ch·ªâ c√≥ 1 n√∫t Hu·ª∑
  if (currentUser !== 'doctor') {
    await confirmDeletePopup(
      '‚ùå √ä l√†m c√°i g√¨ ƒë·∫•yyyy em ∆°i. <br/>D·ª´ng l·∫°i ngay, qu√° nguy hi·ªÉm.',
      true // <-- ch·∫ø ƒë·ªô 1 n√∫t
    );
    return;
  }

  // N·∫øu l√† doctor ‚Üí popup x√°c nh·∫≠n xo√° (2 n√∫t)
  const ok = await confirmDeletePopup(
    'B·∫°n c√≥ ch·∫Øc mu·ªën xo√° m·ª•c n√†y?',
    false
  );
  if (!ok) return;

  try {
    await deleteLogAndFile_ByIndex(indexInLogs);
    await confirmDeletePopup('‚úÖ ƒê√£ xo√° th√†nh c√¥ng!', true);
    await showDropboxPanel();
  } catch (e) {
    console.error(e);
    await confirmDeletePopup('‚ö†Ô∏è C√≥ l·ªói khi xo√°. Vui l√≤ng th·ª≠ l·∫°i.', true);
  }
}

// ƒê√≥ng panel khi b·∫•m ESC ho·∫∑c click ra ngo√†i
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    document.getElementById("dropboxPanel").style.display = "none";
  }
});

document.addEventListener("click", function(e) {
  const panel = document.getElementById("dropboxPanel");
  if (panel.style.display === "block" || panel.style.display === "flex") {
    const content = panel.querySelector("div");
    // N·∫øu click ngo√†i v√πng n·ªôi dung panel
    if (!content.contains(e.target)) {
      panel.style.display = "none";
    }
  }
});

</script>
<script>
// ====== PH√ÇN TRANG B·∫¢NG LOG TRONG POPUP ======
let DB_LOGS = [];       // to√†n b·ªô logs ƒë√£ t·∫£i
let DB_PAGE = 1;        // trang hi·ªán t·∫°i
let DB_PAGE_SIZE = 10;  // s·ªë d√≤ng / trang
let DB_CURRENT_USER = ''; // user ƒëang ƒëƒÉng nh·∫≠p (lowercase) ƒë·ªÉ render n√∫t Xo√°

function setPageSize(size){
  DB_PAGE_SIZE = Number(size) || 10;
  DB_PAGE = 1;
  renderDropboxPage();
}

function goToPage(p){
  const max = Math.max(1, Math.ceil(DB_LOGS.length / DB_PAGE_SIZE));
  DB_PAGE = Math.min(Math.max(1, p), max);
  renderDropboxPage();
}

function renderDropboxPage(){
  const tbody = document.getElementById('dropboxFileList');
  const pageBtns = document.getElementById('dropboxPageButtons');
  const pageInfo = document.getElementById('dropboxPageInfo');

  if(!tbody) return;

  // r·ªóng?
  if(!Array.isArray(DB_LOGS) || DB_LOGS.length === 0){
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:red">Kh√¥ng c√≥ danh s√°ch n√†o ƒë∆∞·ª£c l∆∞u</td></tr>`;
    if(pageBtns) pageBtns.innerHTML = '';
    if(pageInfo) pageInfo.textContent = '';
    return;
  }

  const total = DB_LOGS.length;
  const maxPage = Math.max(1, Math.ceil(total / DB_PAGE_SIZE));
  if(DB_PAGE > maxPage) DB_PAGE = maxPage;

  const startIdx = (DB_PAGE - 1) * DB_PAGE_SIZE;
  const endIdx   = Math.min(startIdx + DB_PAGE_SIZE, total);
  const slice    = DB_LOGS.slice(startIdx, endIdx);

  // Render body theo trang
  tbody.innerHTML = slice.map((item, i) => `
    <tr>
      <td>${startIdx + i + 1}</td>
      <td>${item.khoa || ''}</td>
      <td>${(item.ngay || '')
           .replace('00:00:00','')
           .replace('23:59:59','')
           .replace('T·ª´','')
           .replace('ƒë·∫øn',' -> ')
           .replace(/\s+/g,' ')
           .trim()}</td>
		   
		   <td>${Number(item.herb_errors || 0)}</td>
     <td>${Number(item.time_errors || 0)}</td>
    <td>${Number(item.conflict_errors || 0)}</td>
		   
      <td>${(item.time || '')
           .replace(',', '')
           .replace(' ', ' - ')
           .replace(/\s+/g, ' ')
           .trim()}</td>
      <td><a href="javascript:void(0)" onclick="verifyAndOpenLink('${item.link}')">Xem</a></td>
      <td>
        <button class="btn" style="background:#e74c3c; padding:10px 14px; font-size:12px;"
          onclick="onDeleteLogRow(${startIdx + i}, '${DB_CURRENT_USER}')">
          <i class="fa fa-trash"></i> Xo√°
        </button>
      </td>
    </tr>
  `).join('');

  // Render n√∫t trang (Prev ‚Ä¶ Next) ‚Äî hi·ªÉn th·ªã d·∫£i t·ªëi ƒëa 7 n√∫t s·ªë
  if(pageBtns){
    const btn = (label, target, disabled=false, title='') =>
      `<button class="btn" ${disabled?'disabled':''} title="${title}"
               style="padding:6px 10px${disabled?';opacity:.6;cursor:not-allowed':''}"
               onclick="goToPage(${target})">${label}</button>`;

    const range = 3; // hai b√™n trang hi·ªán t·∫°i
    const from  = Math.max(1, DB_PAGE - range);
    const to    = Math.min(maxPage, DB_PAGE + range);

    let html = '';
    html += btn('¬´ ƒê·∫ßu', 1, DB_PAGE===1, 'Trang ƒë·∫ßu');
    html += btn('‚Äπ Tr∆∞·ªõc', DB_PAGE-1, DB_PAGE===1, 'Trang tr∆∞·ªõc');
    for(let p = from; p <= to; p++){
      html += `<button class="btn" onclick="goToPage(${p})"
                 style="padding:6px 10px;${p===DB_PAGE?'background:#2ecc71':''}">
                 ${p}
               </button>`;
    }
    html += btn('Sau ‚Ä∫', DB_PAGE+1, DB_PAGE===maxPage, 'Trang sau');
    html += btn('Cu·ªëi ¬ª', maxPage, DB_PAGE===maxPage, 'Trang cu·ªëi');

    pageBtns.innerHTML = html;
  }

  if(pageInfo){
    pageInfo.textContent = `Trang ${DB_PAGE}/${maxPage} ‚Ä¢ ${startIdx+1}-${endIdx}/${total}`;
  }
}

// G·∫Øn s·ª± ki·ªán ƒë·ªïi page size (ch·ªâ c·∫ßn g·ªçi 1 l·∫ßn sau khi popup m·ªü)
function attachPagerEventsOnce(){
  const sel = document.getElementById('dropboxPageSize');
  if(sel && !sel.dataset.bound){
    sel.dataset.bound = '1';
    sel.addEventListener('change', e => setPageSize(e.target.value));
  }
}
</script>


<!-- POPUP T√ìM T·∫ÆT L·ªñI -->
<div id="summaryModal" style="display:none;position:fixed;inset:0;z-index:11050">
  <div id="summaryBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,0.5)"></div>
  <div role="dialog" aria-modal="true"
       style="position:absolute;top:6%;left:50%;transform:translateX(-50%);
              width:min(900px,92vw);max-height:86vh;overflow:auto;
              background:#fff;color:#000;border-radius:10px;border:2px solid #3498db;
              box-shadow:0 8px 24px rgba(0,0,0,.25);font-family:Inter,sans-serif">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #e5e7eb">
      <h3 style="margin:0;font-size:18px">T√≥m T·∫Øt L·ªói</h3>
      <button class="btn" type="button" id="summaryCloseBtn">ƒê√≥ng</button>
    </div>
    <div id="summaryContent" style="padding:16px 18px;font-size:14px;line-height:1.5"></div>
  </div>
</div>
<script>
// ===== T√ìM T·∫ÆT L·ªñI (S·∫Øc thu·ªëc / Sai th·ªùi gian / Tr√πng gi·ªù) =====
(function(){
  // Chu·∫©n ho√° t√™n hi·ªÉn th·ªã
  function clean(s){ return (s||'').toString().replace(/,/g,'').replace(/\s+/g,' ').trim(); }

  // Gom nh√≥m: { [doctor]: { total: number, byOperator: Map<op, count> } }
  function makeBucket(){ return { total:0, byOperator:new Map() }; }
 function bump(bucketMap, doctor, operator){
  const d = (doctor||'').toString().replace(/,/g,'').trim() || 'Kh√¥ng c√≥';
  const o = (operator||'').toString().replace(/,/g,'').trim() || 'Kh√¥ng c√≥';
  if(!bucketMap.has(d)) bucketMap.set(d, { total:0, byOperator:new Map() });
  const b = bucketMap.get(d);
  b.total++;
  b.byOperator.set(o, (b.byOperator.get(o)||0)+1);
}

  // 1) ƒê·∫øm S·∫ÆC THU·ªêC THANG
function countHerb(){
  const herbs = Array.isArray(window.allHerbProcedures) ? window.allHerbProcedures : [];
  const norm = s => (s||'').toString().replace(/[,Ôºå]+\s*$/,'').replace(/\s+/g,' ').trim().toLowerCase();

  // 1) ƒê·∫øm t·∫ßn su·∫•t ng∆∞·ªùi th·ª±c hi·ªán theo t·ª´ng ng√†y
  const byDate = Object.create(null);
  herbs.forEach(h=>{
    const d = h.date;
    const op = norm(h.operator);
    if(!op || op === 'kh√¥ng c√≥') return;            // b·ªè tr·ªëng/kh√¥ng c√≥
    (byDate[d]||(byDate[d]=Object.create(null)))[op] = (byDate[d][op]||0) + 1;
  });

  // 2) T√≠nh "ƒëa s·ªë" (top ph·∫£i l·ªõn h∆°n second)
  const majority = Object.create(null);
  Object.keys(byDate).forEach(d=>{
    const arr = Object.entries(byDate[d]).sort((a,b)=>b[1]-a[1]);
    const top    = arr[0] || [null,0];
    const second = arr[1] || [null,0];
    majority[d] = { top: top[0], topCount: top[1], secondCount: second[1] };
  });

  // 3) Ch·ªâ c·ªông nh·ªØng ca KH√ÅC ƒêA S·ªê, gom theo B√°c sƒ© ch·ªâ ƒë·ªãnh (c√¢y ch√≠nh)
  const map = new Map(); // { doctor => {total, byOperator} }  (byOperator s·∫Ω kh√¥ng hi·ªÉn th·ªã)
  herbs.forEach(h=>{
    const d = h.date;
    const op = norm(h.operator);
    if(!op || op === 'kh√¥ng c√≥') return;
    const m = majority[d];
    if(!m) return;
    if(m.top && m.topCount > m.secondCount && op !== m.top){
      // ch·ªâ t√≠nh theo b√°c sƒ© ch·ªâ ƒë·ªãnh (c√¢y ch√≠nh)
      bump(map, h.doctor, '');  // 'byOperator' s·∫Ω b·ªã ·∫©n ·ªü ph·∫ßn render
    }
  });

  return map;
}

  // 2) ƒê·∫øm SAI TH·ªúI GIAN (m·ªçi l·ªói trong errorLog coi l√† l·ªói th·ªùi gian)
 function countTimeErrors(){
  const map = new Map();

  // L·∫•y t·ª´ m·∫£ng errorLog (ki·ªÉu let to√†n c·ª•c)
  const list =
    (typeof errorLog !== 'undefined' && Array.isArray(errorLog)) ? errorLog :
    (Array.isArray(window.errorLog) ? window.errorLog : []);

  // Ch·ªâ l·∫•y l·ªói l·ªách th·ªùi l∆∞·ª£ng (c√≥ expected/actual)
  list.forEach(e => {
    const d = e && e.details;
    if (!d) return;
    if (typeof d.expected === 'number' && typeof d.actual === 'number') {
      bump(map, d.doctor, d.operator);
    }
  });

  // Fallback: ƒë·ªçc tr·ª±c ti·∫øp t·ª´ b·∫£ng l·ªói th·ªùi gian n·∫øu v√¨ l√Ω do n√†o ƒë√≥ m·∫£ng r·ªóng
  if (map.size === 0) {
    document.querySelectorAll('#errorLog tr.error-row').forEach(tr => {
      const tds = tr.querySelectorAll('td');
      // B·∫£ng c√≥ c·ªôt: T√™n BN | Th·ªß thu·∫≠t | B√°c s·ªπ ch·ªâ ƒë·ªãnh | Ng∆∞·ªùi th·ª±c hi·ªán | Th·ªùi gian | L·ªói
      const doctor   = tds[2]?.textContent?.trim();
      const operator = tds[3]?.textContent?.trim();
      if (doctor || operator) bump(map, doctor, operator);
    });
  }

  return map;
}

  // 3) ƒê·∫øm TR√ôNG GI·ªú (t·ª´ allProcedures.conflict=true)
function countConflicts(){
  const list =
    (typeof allProcedures !== 'undefined' && Array.isArray(allProcedures)) ? allProcedures :
    (Array.isArray(window.allProcedures) ? window.allProcedures : []);
  const map = new Map();
  list.forEach(p => {
    if (p && p.conflict) bump(map, p.doctor, p.operator);
  });
  return map;
}
function buildDoctorRanking(herbMap, timeMap, confMap){
  const totalMap = new Map();

  // g·ªôp s·ªë t·ª´ 3 map
  const merge = (src) => {
    src.forEach((info, doc)=>{
      if(!totalMap.has(doc)) totalMap.set(doc,{total:0});
      totalMap.get(doc).total += info.total;
    });
  };
  merge(herbMap); merge(timeMap); merge(confMap);

  // sort gi·∫£m d·∫ßn
  const arr = Array.from(totalMap.entries()).sort((a,b)=>b[1].total - a[1].total);

  let html = `<div class="section"><div class="inner">`;
  if(arr.length===0){
    html += `<div class="note-empty">Ch∆∞a c√≥ d·ªØ li·ªáu</div>`;
  } else {
    html += `<table class="table-clean"><thead><tr>
              <th>H·∫°ng</th><th>B√°c sƒ©</th>
              <th class="right">T·ªïng l·ªói</th>
            </tr></thead><tbody>`;
    arr.forEach(([doc,info],i)=>{
      html += `<tr>
        <td>${i+1}</td>
        <td><b>${doc}</b></td>
        <td class="right">${info.total}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
  }
  html += `</div></div>`;
  return html;
}
  // Render 1 section
function renderSection(title, map, showOperators = true){
  if(!map || map.size===0){
    return `<h4 style="margin:10px 0 6px">${title}</h4><div><i>Ch∆∞a c√≥ d·ªØ li·ªáu</i></div>`;
  }
  const doctors = Array.from(map.entries()).sort((a,b)=>b[1].total - a[1].total);

  let html = `<h4 style="margin:10px 0 6px">${title}</h4><div style="border:1px solid #eee;border-radius:8px;padding:12px">`;
  doctors.forEach(([doctor, info])=>{
    html += `<div style="margin-bottom:10px">
      <div>B√°c sƒ© <b>${doctor}:</b> ${info.total}</div>`;
    if (showOperators){
      const ops = Array.from(info.byOperator.entries()).sort((a,b)=>b[1]-a[1]);
      if(ops.length){
        html += `<div style="margin-left:12px;margin-top:4px">` +
                ops.map(([op,c]) => `- ${op}: ${c}`).join('<br>') +
                `</div>`;
      }
    }
    html += `</div>`;
  });
  html += `</div>`;
  return html;
}

  function buildSummaryHTML(){
    const herbMap = countHerb();
    const timeMap = countTimeErrors();
    const confMap = countConflicts();

    // T·ªïng nhanh (d√≤ng ƒë·∫ßu)
    const herbTotal = Array.from(herbMap.values()).reduce((s,b)=>s+b.total,0);
    const timeTotal = Array.from(timeMap.values()).reduce((s,b)=>s+b.total,0);
    const confTotal = Array.from(confMap.values()).reduce((s,b)=>s+b.total,0);

    let top = ` <div class="summary-wrap">
      <div class="kpi-grid">
        <div class="kpi-card kpi-blue">
          <div class="kpi-title"><i class="fa-solid fa-mortar-pestle"></i> S·∫Øc thu·ªëc thang</div>
          <div class="kpi-value">${herbTotal}</div>
        </div>
        <div class="kpi-card kpi-amber">
          <div class="kpi-title"><i class="fa-regular fa-clock"></i> Sai th·ªùi gian</div>
          <div class="kpi-value">${timeTotal}</div>
        </div>
        <div class="kpi-card kpi-red">
          <div class="kpi-title"><i class="fa-solid fa-triangle-exclamation"></i> Tr√πng gi·ªù</div>
          <div class="kpi-value">${confTotal}</div>
        </div>
      </div>`;

    return top
      + renderSection('S·∫Øc thu·ªëc thang', herbMap, /*showOperators*/ false) 
      + '<br/>'
      + renderSection('Sai th·ªùi gian', timeMap)
      + '<br/>'
      + renderSection('Tr√πng gi·ªù', confMap);
  }

  // M·ªü/ƒë√≥ng modal
  window.openErrorSummary = function(){
    const modal = document.getElementById('summaryModal');
    const content = document.getElementById('summaryContent');
    if(!modal || !content) return;
// l·∫•y 3 map ƒë·ªÉ truy·ªÅn cho b·∫£ng x·∫øp h·∫°ng
const herbMap = countHerb();
const timeMap = countTimeErrors();
const confMap = countConflicts();

// n·ªôi dung popup = ph·∫ßn t√≥m t·∫Øt c≈© + b·∫£ng x·∫øp h·∫°ng b√°c sƒ©
content.innerHTML = buildSummaryHTML()
  + buildDoctorRanking(herbMap, timeMap, confMap);
    modal.style.display = 'block';
  };
  document.getElementById('summaryCloseBtn')?.addEventListener('click', ()=> {
    document.getElementById('summaryModal').style.display='none';
  });
  document.getElementById('summaryBackdrop')?.addEventListener('click', ()=> {
    document.getElementById('summaryModal').style.display='none';
  });

  // Sau khi ‚ÄúKi·ªÉm Tra‚Äù xong, hi·ªán n√∫t T√≥m T·∫Øt L·ªói (theo c√πng c∆° ch·∫ø nh∆∞ 2 n√∫t kia)
  // (ƒê√£ c√≥ logic hi·ªán n√∫t trong setTimeout sau analyze ‚Äî ta ch·ªâ ƒë·∫£m b·∫£o n√∫t n√†y c≈©ng hi·ªán)
  const orig = setTimeout;
  // Kh√¥ng c·∫ßn hook, v√¨ code c√≥ ƒëo·∫°n:
  // document.querySelectorAll('button.btn').forEach(btn => {
  //   if (btn.textContent.includes('Gi·ªù tr·ªëng') || btn.textContent.includes('S·∫Øc thu·ªëc thang')) { btn.style.display='inline-block';}
  // });
  // -> Ta th√™m d√≤ng d∆∞·ªõi ƒë·ªÉ n√∫t m·ªõi c≈©ng ƒë∆∞·ª£c b·∫≠t:
  document.addEventListener('DOMContentLoaded', () => {
    // Khi popup loading t·∫Øt sau analyze, ta b·∫≠t th·ªß c√¥ng n·∫øu ƒë√£ c√≥ d·ªØ li·ªáu:
    // (an to√†n n·∫øu g·ªçi nhi·ªÅu l·∫ßn)
    const showIfData = () => {
      if (Array.isArray(window.allProcedures) && window.allProcedures.length){
        const b = document.getElementById('errorSummaryBtn');
        if (b) b.style.display = 'inline-block';
      }
    };
    // ch·∫°y ngay v√† sau m·ªói l·∫ßn l·ªçc/render
    showIfData();
    // g·∫Øn v√†o c√°c ƒëi·ªÉm ƒë√£ c√≥:
    const rb = document.getElementById('resultBody');
    const el = document.getElementById('errorLog');
    const obs = new MutationObserver(showIfData);
    if (rb) obs.observe(rb, {childList:true,subtree:true});
    if (el) obs.observe(el, {childList:true,subtree:true});
  });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('errorSummaryBtn');
  const herbBtn = document.getElementById('herbToggleBtn');
  const availBtn = document.querySelector('button.btn[onclick="toggleAvailability()"]');

  function syncShow(){
    if (!btn) return;
    const herbShown  = herbBtn && getComputedStyle(herbBtn).display !== 'none';
    const availShown = availBtn && getComputedStyle(availBtn).display !== 'none';
    if (herbShown || availShown) btn.style.display = 'inline-block';
  }

  // ch·∫°y ngay v√† khi c√≥ thay ƒë·ªïi hi·ªÉn th·ªã
  syncShow();
  new MutationObserver(syncShow).observe(document.body, {
    attributes: true, subtree: true, attributeFilter: ['style','class']
  });
});


</script>
<!-- POPUP TU·ª≤ BI·∫æN TH·ª¶ THU·∫¨T -->
<div id="customizeModal" style="display:none;position:fixed;inset:0;z-index:11060;">
  <div style="position:absolute;inset:0;background:rgba(0,0,0,0.5)" onclick="closeCustomizePanel()"></div>
  <div style="
      position:absolute;top:8%;left:50%;transform:translateX(-50%);
      width:min(820px,92vw);max-height:84vh;overflow:auto;
      background:#fff;color:#000;border-radius:10px;border:2px solid #3498db;
      box-shadow:0 8px 24px rgba(0,0,0,.25);font-family:Inter,sans-serif">
  <div style="display:flex;align-items:center;justify-content:space-between;
            padding:14px 16px;border-bottom:1px solid #e5e7eb">
  <h3 style="margin:0;font-size:18px">B·∫£ng Tu·ª≥ bi·∫øn Th·ªß thu·∫≠t</h3>
  <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
  <button class="btn" onclick="showNoPermission()"
          style="padding:8px 14px;font-size:13px;border-radius:4px;">
    Th√™m
  </button>
  <button class="btn" onclick="closeCustomizePanel()"
          style="padding:8px 14px;font-size:13px;border-radius:4px;">
    ƒê√≥ng
  </button>
</div>
</div>
    <div style="padding:0px 16px">
    
      <table class="error-table" style="width:100%">
        <thead>
          <tr>
            <th style="width:60px">STT</th>
            <th>Th·ªß Thu·∫≠t</th>
            <th style="width:130px">Th·ªùi gian</th>
            <th style="width:110px">Chu·∫©n b·ªã</th>
          </tr>
        </thead>
        <tbody id="customizeBody"></tbody>
      </table>
  
  </div>
</div>
<script>
  const THUTHUAT_URL = 'https://raw.githubusercontent.com/chauhuynh0104/chauhuynh0104.txt/refs/heads/main/chau_thuthuat.txt';

  async function openCustomizePanel() {
    try {
      if (!window.PROCEDURES || Object.keys(window.PROCEDURES).length === 0) {
        const res = await fetch(THUTHUAT_URL);
        const text = await res.text();
        window.PROCEDURES = JSON.parse(text);
      }
    } catch (e) {
      alert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch th·ªß thu·∫≠t t·ª´ m√°y ch·ªß.');
      return;
    }

    const rows = [];
    Object.entries(PROCEDURES).forEach(([name, cfg]) => {
      if (!name || !cfg) return;

      const duration = (typeof cfg.duration === 'number') ? cfg.duration : '';
      // N·∫øu c√≥ prep th√¨ l·∫•y prep, n·∫øu kh√¥ng c√≥ th√¨ g√°n = duration
      const prep = (typeof cfg.prep === 'number') ? cfg.prep : duration;

      if (duration !== '') {
        rows.push({ name, duration, prep });
      }
    });

    rows.sort((a,b) => a.name.localeCompare(b.name, 'vi'));

    const tbody = document.getElementById('customizeBody');
    tbody.innerHTML = rows.map((r, idx) => `
      <tr>
        <td style="text-align:center">${idx + 1}</td>
        <td>${r.name}</td>
        <td style="text-align:center">${r.duration}</td>
        <td style="text-align:center">${r.prep}</td>
      </tr>
    `).join('');

    document.getElementById('customizeModal').style.display = 'block';
  }

  function closeCustomizePanel() {
    document.getElementById('customizeModal').style.display = 'none';
  }
</script>
<script>
function showNoPermission() {
  // Overlay
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position:fixed;inset:0;background:rgba(0,0,0,0.5);
    display:flex;justify-content:center;align-items:center;z-index:12000;
  `;

  // Box
  const box = document.createElement('div');
  box.style.cssText = `
    background:#fff;padding:20px 30px;border-radius:10px;
    text-align:center;max-width:320px;box-shadow:0 4px 15px rgba(0,0,0,0.3);
    font-family:Inter,sans-serif;
  `;
  box.innerHTML = `
    <div style="font-size:18px;font-weight:600;color:#e74c3c;margin-bottom:10px;">
      üö´ B·∫°n kh√¥ng c√≥ quy·ªÅn th√™m th·ªß thu·∫≠t
    </div>
    <button class="btn" onclick="document.body.removeChild(this.closest('.noPermOverlay'))">
      ƒê√≥ng
    </button>
  `;
  overlay.classList.add("noPermOverlay");
  overlay.appendChild(box);
  overlay.addEventListener("click", e => {
    if (e.target === overlay) document.body.removeChild(overlay);
  });
  document.body.appendChild(overlay);
}
</script>

<!-- POPUP T·∫†O GI·ªú TH·ª¶ THU·∫¨T -->
<div id="createProcedureModal" style="display:none;position:fixed;inset:0;z-index:12000;">
  <div style="position:absolute;inset:0;background:rgba(0,0,0,0.6)" onclick="closeCreateProcedure()"></div>
  <div style="
      position:absolute;top:6%;left:50%;transform:translateX(-50%);
      width:min(900px,95vw);height:85vh;
      background:#fff;color:#000;border-radius:10px;border:2px solid #3498db;
      box-shadow:0 8px 24px rgba(0,0,0,.25);font-family:Inter,sans-serif;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#3498db;color:#fff;">
      <h3 style="margin:0;font-size:16px">T·∫°o Gi·ªù Th·ªß Thu·∫≠t</h3>
      <button class="btn" onclick="closeCreateProcedure()" style="background:#e74c3c;padding:6px 12px;font-size:13px;">ƒê√≥ng</button>
    </div>
    <iframe id="createProcedureFrame" src="" style="width:100%;height:calc(100% - 40px);border:0"></iframe>
  </div>
</div>

<script>
function openCreateProcedure() {
    document.getElementById('createProcedureFrame').src = "https://chauhuynh0104.github.io/gym/ltt.html";
    document.getElementById('createProcedureModal').style.display = 'block';
}
function closeCreateProcedure() {
    document.getElementById('createProcedureFrame').src = "";
    document.getElementById('createProcedureModal').style.display = 'none';
}
</script>
</body>

</html>